# 用戶流程與需求

## 主要用戶流程 (User Flows)

### Flow-0: 首次啟動設定流程（系統初始化）

**前置條件：**
- 用戶已安裝應用程式
- 首次啟動系統

**主流程：**

| 步驟 | 用戶操作 | 系統回應 | 預期結果 |
|-----|---------|---------|---------|
| 1 | 啟動應用程式 | 檢測是否為首次啟動 | 顯示「歡迎使用 YTMaker」畫面 |
| 2 | 點擊「開始設定」 | 進入系統設定精靈 | 顯示 API 設定頁面 |
| 3 | 輸入 Gemini API Key | 驗證 API Key 格式 | API Key 已儲存 |
| 4 | 點擊「測試連線」 | 調用 Gemini API 測試 | 顯示「連線成功」或錯誤訊息 |
| 5 | 輸入 Stability AI API Key | 驗證 API Key 格式 | API Key 已儲存 |
| 6 | 點擊「測試連線」 | 調用 Stability AI API 測試 | 顯示「連線成功」或錯誤訊息 |
| 7 | 輸入 D-ID API Key | 驗證 API Key 格式 | API Key 已儲存 |
| 8 | 點擊「測試連線」 | 調用 D-ID API 測試 | 顯示「連線成功」或錯誤訊息 |
| 9 | 點擊「連結 YouTube 帳號」 | 開啟 OAuth 授權視窗 | 顯示 Google 登入頁面 |
| 10 | 完成 Google OAuth 授權 | 取得 YouTube API 權限 | 顯示「已連結：[頻道名稱]」 |
| 11 | 點擊「完成設定」 | 儲存所有設定到本地 | 進入主控台 |

**成功結束：**
- 所有 API Keys 已設定並測試通過
- YouTube 帳號已連結
- 進入主控台，可開始使用

**替代路徑：**

**4a/6a/8a. API Key 無效：**
- 系統：顯示「API Key 無效，請檢查」
- 用戶：重新輸入正確的 API Key
- 返回相應步驟

**10a. 用戶取消 OAuth 授權：**
- 系統：提示「未連結 YouTube 帳號，您仍可生成影片但無法自動上傳」
- 用戶選擇：稍後設定或現在重試
- 繼續步驟 11

**11a. 用戶選擇「稍後設定」：**
- 系統：儲存已輸入的設定
- 提示：「部分功能可能無法使用，請到設定頁面完成配置」
- 進入主控台

---

### Flow-1: 基本影片生成流程（必要功能）

**前置條件：**
- 用戶已完成首次啟動設定（Flow-0）
- 所有必要的 API 金鑰已設定（Gemini、D-ID、Stability AI、YouTube API）
- 用戶已準備好文字內容（500-10000字）

**主流程：**

| 步驟 | 用戶操作 | 系統回應 | 預期結果 |
|-----|---------|---------|---------|
| 1 | 點擊「新增專案」 | 進入專案配置流程 | 顯示「步驟 1: 上傳文字內容」頁面 |
| 2 | 提供文字內容（上傳檔案或貼上） | 驗證文字長度（500-10000字） | 驗證通過，顯示字數，進入下一步 |
| 3 | 配置視覺元素（字幕、Logo、疊加元素） | 即時預覽效果 | 視覺配置已儲存，進入下一步 |
| 4 | 選擇 Prompt 範本（或新增自訂範本） | 顯示 Prompt 內容 | Prompt 已選擇 |
| 5 | 選擇 Gemini 模型（pro 或 flash） | 顯示模型特性說明 | 模型已選擇，進入下一步 |
| 6 | 設定 YouTube 資訊（標題、描述、標籤、隱私） | 自動生成建議內容（可編輯） | YouTube 設定已完成 |
| 7 | 選擇 YouTube 頻道（如有多個） | 顯示已連結的頻道列表 | 頻道已選擇 |
| 8 | 點擊「開始生成」 | 開始腳本生成流程 | 進入進度監控頁面 |
| 9 | 等待腳本生成（3分鐘內） | 調用 Gemini API，生成結構化腳本 | 腳本生成完成，包含開場、動態數量段落（每段 5-20 秒）、結尾 |
| 10 | 等待素材生成（3-5分鐘） | 並行生成：語音、圖片、虛擬主播 | 所有素材生成完成 |
| 11 | 等待影片渲染（10-15分鐘） | FFmpeg 進行影片合成、字幕燒錄、效果添加 | 生成 final_video.mp4 |
| 12 | 等待封面生成（1分鐘） | 基於第一張圖生成封面 | 生成 thumbnail.jpg |
| 13 | 自動上傳到 YouTube | 上傳影片和封面，設定 metadata | 影片成功發布到 YouTube |
| 14 | 查看結果 | 顯示 YouTube 連結和本地檔案 | 影片已完成並可查看

**成功結束：**
- YouTube 上已發布影片
- 本地保存有 final_video.mp4 和 thumbnail.jpg
- 系統顯示 YouTube 影片連結

**替代路徑：**

**2a. 文字內容長度不符：**
- 系統：提示「文字長度必須在 500-10000 字之間」
- 用戶：修改文字內容
- 返回步驟 2

**3a. 使用模板配置：**
- 用戶：點擊「載入模板」
- 系統：顯示可用模板列表
- 用戶：選擇模板
- 系統：自動套用模板配置
- 繼續步驟 4

**4a. 新增自訂 Prompt 範本：**
- 用戶：點擊「新增範本」
- 系統：顯示 Prompt 編輯器
- 用戶：輸入 Prompt 內容並命名
- 系統：儲存為新範本
- 繼續步驟 5

**7a. YouTube 帳號未連結：**
- 系統：提示「請先連結 YouTube 帳號」
- 用戶：點擊「連結帳號」
- 系統：開啟 OAuth 授權視窗
- 用戶：完成授權
- 返回步驟 7

**10a. 素材生成失敗（某個 API 失敗）：**
- 系統：自動重試（最多 3 次）
- 如仍失敗：記錄錯誤，暫停流程
- 用戶：檢查 API 配額或網路連線
- 用戶：點擊「重試」從失敗點繼續

**13a. YouTube 配額不足：**
- 系統：提示「YouTube API 配額不足」
- 用戶：選擇排程發布或稍後重試
- 系統：保存影片和 metadata，等待用戶指示

**13b. 選擇排程發布：**
- 步驟 6：選擇「排程發布」
- 用戶：設定發布日期和時間
- 系統：驗證為未來時間
- 步驟 13：上傳為排程狀態
- 結果：影片已上傳但未發布，等待排程時間

---

### Flow-2: 使用模板快速生成

**前置條件：**
- 用戶已創建並保存過配置模板
- 已準備文字內容

**主流程：**

| 步驟 | 用戶操作 | 系統回應 | 預期結果 |
|-----|---------|---------|---------|
| 1 | 執行 `list-templates` 命令 | 顯示所有可用模板及描述 | 用戶看到模板列表 |
| 2 | 選擇模板名稱（如 `tech-review`） | 載入模板配置 | 配置已載入 |
| 3 | 提供文字內容 | 驗證文字長度 | 驗證通過 |
| 4 | 執行 `generate --template tech-review` | 使用模板配置開始生成 | 進入 Flow-1 步驟 3 |

**成功結束：**
- 同 Flow-1

**替代路徑：**

**2a. 模板不存在：**
- 系統：提示「找不到模板 'xxx'」
- 用戶：查看可用模板列表
- 返回步驟 1

---

### Flow-3: 使用視覺化界面配置視覺元素

**前置條件：**
- 用戶進入配置界面（類似線上剪輯軟體）
- （可選）已有現成的配置模板

**主流程：**

| 步驟 | 用戶操作 | 系統回應 | 預期結果 |
|-----|---------|---------|---------|
| 1 | 點擊「配置視覺元素」按鈕 | 進入視覺化配置界面 | 顯示預覽畫面和配置面板 |
| 2 | 拖拽字幕到期望位置 | 即時更新預覽 | 字幕位置已調整 |
| 3 | 調整字幕樣式（字型、大小、顏色、邊框） | 即時更新預覽 | 字幕樣式已調整 |
| 4 | 拖拽 Logo 到期望位置並調整大小 | 即時更新預覽 | Logo 已定位 |
| 5 | 配置其他疊加元素（標題、圖標、形狀） | 即時更新預覽 | 所有元素已配置 |
| 6 | （可選）設定段落級覆寫 | 顯示段落選擇器 | 特定段落使用不同配置 |
| 7 | 點擊「保存配置」 | 驗證配置並保存 | 配置已保存 |
| 8 | （可選）點擊「儲存為模板」並命名 | 保存為可重複使用的模板 | 模板已保存 |

**成功結束：**
- 視覺元素配置已完成並保存
- （可選）配置已儲存為模板

**替代路徑：**

**7a. 配置參數超出範圍：**
- 系統：高亮顯示錯誤位置，提示具體問題
- 用戶：在視覺化界面調整
- 返回步驟 7

**7b. 元素位置重疊或超出畫面：**
- 系統：顯示警告提示
- 用戶：調整元素位置
- 返回步驟 2-5

---

### Flow-4: 排程發布影片

**前置條件：**
- 影片已生成（final_video.mp4 和 thumbnail.jpg）
- 用戶希望在特定時間發布

**主流程：**

| 步驟 | 用戶操作 | 系統回應 | 預期結果 |
|-----|---------|---------|---------|
| 1 | 執行 `generate --schedule "2025-10-20T10:00:00"` | 驗證時間格式和未來時間 | 時間驗證通過 |
| 2 | 確認執行 | 開始生成流程（同 Flow-1 步驟 3-9） | 影片和封面已生成 |
| 3 | 等待上傳 | 上傳影片，設定為排程發布 | 影片已上傳，排程已設定 |

**成功結束：**
- YouTube 顯示影片為「已排程」狀態
- 系統顯示排程時間

**替代路徑：**

**1a. 時間格式錯誤：**
- 系統：提示「時間格式必須為 ISO 8601 格式」
- 用戶：修正時間格式
- 返回步驟 1

**1b. 時間為過去時間：**
- 系統：提示「排程時間必須為未來時間」
- 用戶：修正時間
- 返回步驟 1

---

### Flow-5: 批次處理多個影片

**前置條件：**
- 用戶已準備多個文字內容檔案
- 已配置好模板或配置檔案

**主流程：**

| 步驟 | 用戶操作 | 系統回應 | 預期結果 |
|-----|---------|---------|---------|
| 1 | 創建批次配置檔案（batch.json） | 無 | 批次檔案已創建 |
| 2 | 執行 `batch-generate batch.json` | 驗證批次檔案格式 | 驗證通過 |
| 3 | 確認執行 | 顯示批次任務數量 | 用戶確認批次任務 |
| 4 | 等待批次執行 | 依序處理每個任務（Flow-1） | 所有任務完成 |
| 5 | 檢視批次報告 | 顯示成功/失敗數量和詳細日誌 | 用戶了解批次結果 |

**成功結束：**
- 所有影片已生成並上傳
- 批次報告已生成

**替代路徑：**

**2a. 批次檔案格式錯誤：**
- 系統：提示格式錯誤
- 用戶：修正批次檔案
- 返回步驟 2

**4a. 部分任務失敗：**
- 系統：繼續處理其他任務，記錄失敗任務
- 完成後顯示失敗任務列表
- 用戶：檢查失敗原因，手動重試失敗任務

**4b. API 配額用盡：**
- 系統：暫停批次處理，保存進度
- 用戶：等待配額恢復或升級方案
- 用戶：執行 `resume-batch` 繼續處理

---

### Flow-6: 斷點續傳與錯誤恢復

**前置條件：**
- 生成過程中發生錯誤或中斷
- 部分素材已生成

**主流程：**

| 步驟 | 用戶操作 | 系統回應 | 預期結果 |
|-----|---------|---------|---------|
| 1 | 執行 `resume [project-id]` | 檢測已完成的步驟 | 顯示進度和待完成步驟 |
| 2 | 確認繼續 | 從失敗點繼續執行 | 跳過已完成步驟 |
| 3 | 等待完成 | 完成剩餘步驟 | 影片生成完成 |

**成功結束：**
- 影片生成完成，無需重複已完成步驟

**替代路徑：**

**1a. 找不到項目：**
- 系統：提示「找不到項目 [project-id]」
- 用戶：檢查項目 ID 或執行 `list-projects`
- 返回步驟 1

**1b. 項目已完成：**
- 系統：提示「項目已完成，無需恢復」
- 用戶：查看已生成的影片

---

### Flow-7: 段落級配置覆寫

**前置條件：**
- 用戶希望特定段落有不同的視覺效果
- 已在視覺化配置界面中設定全局配置

**主流程：**

| 步驟 | 用戶操作 | 系統回應 | 預期結果 |
|-----|---------|---------|---------|
| 1 | 在配置界面中點擊「段落級配置」 | 顯示段落選擇器和配置面板 | 進入段落級配置模式 |
| 2 | 選擇要覆寫的段落編號 | 顯示該段落的當前配置 | 段落已選擇 |
| 3 | 修改該段落的視覺配置 | 即時更新該段落的預覽 | 配置已修改 |
| 4 | 保存配置 | 驗證覆寫配置 | 配置已保存 |
| 5 | 執行生成命令 | 使用全局配置 + 段落覆寫 | 影片已生成 |
| 6 | 檢視影片 | 特定段落使用不同配置 | 符合預期 |

**成功結束：**
- 影片中特定段落使用了自訂配置

**替代路徑：**

**2a. 段落編號不存在：**
- 系統：提示「該段落不存在（腳本共 X 個段落）」
- 用戶：選擇有效的段落編號
- 返回步驟 2

---

### Flow-8: Prompt 範本管理

**前置條件：**
- 用戶希望自訂腳本生成的 Prompt
- 已進入設定或配置界面

**主流程：**

| 步驟 | 用戶操作 | 系統回應 | 預期結果 |
|-----|---------|---------|---------|
| 1 | 點擊「Prompt 範本管理」 | 顯示現有 Prompt 範本列表 | 用戶看到所有範本 |
| 2 | 選擇「預設範本」查看內容 | 顯示 Prompt 文字（包含「每段 5-20 秒」要求） | 用戶看到範本內容 |
| 3 | 點擊「編輯」或「新增範本」 | 進入 Prompt 編輯界面 | 顯示文字編輯器 |
| 4 | 修改 Prompt 內容（調整風格、語氣、段落要求等） | 即時顯示字數統計 | Prompt 已修改 |
| 5 | 點擊「儲存為新範本」並命名 | 驗證 Prompt 格式 | 新範本已保存 |
| 6 | 在生成流程中選擇此 Prompt 範本 | 載入 Prompt 範本 | 使用自訂 Prompt 生成腳本 |

**成功結束：**
- 自訂 Prompt 範本已建立並可使用

**替代路徑：**

**4a. Prompt 內容過長或過短：**
- 系統：提示「Prompt 長度建議在 X-Y 字之間」
- 用戶：調整 Prompt 長度
- 返回步驟 4

**4b. Prompt 缺少關鍵要求：**
- 系統：警告「建議包含段落時長要求（5-20 秒）」
- 用戶選擇：忽略警告或添加要求
- 繼續步驟 5

---

### Flow-9: 系統設定管理

**前置條件：**
- 用戶希望修改系統設定（API Keys、YouTube 授權等）
- 已進入設定頁面

**主流程：**

| 步驟 | 用戶操作 | 系統回應 | 預期結果 |
|-----|---------|---------|---------|
| 1 | 點擊導航列「設定」 | 進入設定頁面 | 顯示設定選項（API 金鑰、偏好設定、帳號） |
| 2 | 選擇「API 金鑰」分頁 | 顯示所有 API 設定狀態 | 用戶看到每個 API 的狀態（已設定/未設定） |
| 3 | 點擊某個 API 的「編輯」按鈕 | 顯示 API Key 輸入框 | 用戶可輸入或修改 API Key |
| 4 | 輸入新的 API Key | 驗證格式 | API Key 格式正確 |
| 5 | 點擊「測試連線」 | 調用對應 API 測試 | 顯示「連線成功」或錯誤訊息 |
| 6 | 點擊「儲存」 | 更新 API Key 到本地配置 | 顯示「已儲存」通知 |

**成功結束：**
- API Key 已更新並測試通過
- 系統使用新的 API Key

**替代路徑：**

**5a. API Key 無效或測試失敗：**
- 系統：顯示錯誤訊息（例如：「API Key 無效」或「連線失敗」）
- 用戶：檢查並重新輸入 API Key
- 返回步驟 4

**6a. YouTube 授權管理：**
- 步驟 3：點擊「YouTube API」的「連結帳號」按鈕
- 系統：開啟 OAuth 授權視窗
- 用戶：完成 Google 授權
- 系統：顯示「已連結：[頻道名稱]」
- 用戶可點擊「變更頻道」重新授權

**6b. 查看 API 配額：**
- 設定頁面顯示各 API 的配額使用情況
- D-ID：剩餘 XX 分鐘 / 90 分鐘
- YouTube：剩餘 X,XXX units / 10,000 units
- 提供進度條視覺化顯示

---

## 邊界情況 (Edge Cases)

### EC-1: 用戶中途離開

**情境：** 用戶在生成過程中關閉程式或斷線

**系統行為：**
- 立即保存當前進度（已完成步驟、已生成素材）
- 寫入狀態檔案（project_state.json）
- 記錄最後完成的步驟

**恢復方式：**
- 用戶執行 `resume [project-id]`
- 系統從狀態檔案載入進度
- 從最後完成步驟的下一步繼續

---

### EC-2: 網路連線問題

**情境：** API 調用時網路不穩定

**系統行為：**
- 自動重試（指數退避，最多 3 次）
- 每次重試間隔：2秒、4秒、8秒
- 記錄每次重試的錯誤訊息

**失敗處理：**
- 3 次重試後仍失敗：暫停流程，保存進度
- 提示用戶檢查網路連線
- 用戶可選擇立即重試或稍後恢復

---

### EC-3: 並行處理資源衝突

**情境：** 多個素材生成任務同時佔用 CPU/網路資源

**系統行為：**
- 限制並行數量（最多 4 個任務）
- 使用任務佇列（先進先出）
- 監控系統資源使用率

**資源不足處理：**
- CPU 使用率 > 90%：暫停新任務，等待現有任務完成
- 記憶體不足：降低並行數量（4 → 2 → 1）
- 提示用戶關閉其他程式或升級硬體

---

### EC-4: API 配額即將用盡

**情境：** D-ID 或 YouTube API 配額接近上限

**系統行為：**
- 在生成前檢查配額剩餘量
- 配額 < 10%：顯示警告訊息
- 配額 < 1%：提示用戶升級方案或等待配額恢復

**預防措施：**
- 批次處理前先估算配額需求
- 提供配額用量報告（每日/每月）

---

### EC-5: 生成的腳本段落時長不符

**情境：** Gemini 生成的腳本某些段落時長不在 5-20 秒範圍內

**系統行為：**
- 驗證腳本結構（開場 + 段落 + 結尾）
- 檢測每段預估時長（基於字數和語速）
- 段落時長 < 5 秒或 > 20 秒：標記警告
- 顯示不符合的段落清單

**用戶選擇：**
- 接受時長不標準的段落（繼續生成）
- 手動調整腳本（合併或拆分段落）
- 修改 Prompt 範本後重新生成
- 直接重新生成（使用相同 Prompt）

---

### EC-6: 素材生成部分失敗

**情境：** 部分圖片生成失敗（例如：20 張圖片中有 3 張失敗）

**系統行為：**
- 記錄失敗的圖片編號和錯誤原因
- 自動重試失敗的圖片（最多 3 次）
- 如仍失敗：標記該段落，提供選項

**用戶選擇：**
- 使用佔位圖繼續
- 手動提供替代圖片
- 放棄該段落（調整腳本，移除該段落）
- 修改該段落的圖片描述後重新生成

---

### EC-7: 磁碟空間不足

**情境：** 渲染過程中磁碟空間不足

**系統行為：**
- 在開始前檢查可用空間（需要 > 1GB）
- 渲染前再次檢查
- 空間不足：暫停流程，提示用戶清理空間

**恢復方式：**
- 用戶清理空間後執行 `resume`
- 系統從暫停點繼續

---

### EC-8: YouTube 上傳超時

**情境：** 網路不穩定導致上傳超時

**系統行為：**
- 設定超時時間（600 秒）
- 超時後自動重試（最多 3 次）
- 使用斷點續傳（如 YouTube API 支援）

**失敗處理：**
- 保存影片和 metadata 到本地
- 提示用戶手動上傳或稍後重試
- 提供手動上傳指令

---

### EC-9: 虛擬主播 API 回傳時長不符

**情境：** D-ID 回傳的影片時長與音訊不匹配

**系統行為：**
- 驗證影片時長（誤差 < 5%）
- 時長不符：記錄警告，嘗試重新生成
- 多次失敗：跳過虛擬主播，使用純音訊 + 圖片

**用戶選擇：**
- 接受時長誤差
- 重新生成虛擬主播影片
- 關閉虛擬主播功能

---

### EC-10: 配置檔案中存在未知參數

**情境：** 用戶使用舊版配置或拼寫錯誤

**系統行為：**
- 驗證時列出所有未知參數
- 提供建議的正確參數名稱
- 選擇：忽略未知參數或中止驗證

**用戶選擇：**
- 修正配置檔案
- 忽略未知參數（使用預設值）

---

## 錯誤處理

### E-1: API 錯誤

**錯誤類型：**
- **E-1.1:** Gemini API 失敗（腳本生成）
- **E-1.2:** Stability AI 失敗（圖片生成）
- **E-1.3:** D-ID 失敗（虛擬主播）
- **E-1.4:** YouTube API 失敗（上傳）

**錯誤訊息範例：**
```
[E-1.1] Gemini API 錯誤：API 金鑰無效
[E-1.2] Stability AI 錯誤：圖片生成超時（圖片 #7）
[E-1.3] D-ID 錯誤：配額已用盡
[E-1.4] YouTube API 錯誤：上傳失敗（網路問題）
```

**處理流程：**
1. 記錄詳細錯誤訊息（API 回應、時間戳）
2. 自動重試（最多 3 次）
3. 失敗後保存進度
4. 提示用戶檢查：
   - API 金鑰是否有效
   - 配額是否足夠
   - 網路連線是否正常

**用戶操作：**
- 檢查並修正 API 金鑰
- 升級 API 方案
- 等待配額恢復
- 執行 `resume` 繼續

**重試機制：**
- 指數退避：2秒、4秒、8秒
- 最多 3 次重試
- 可配置重試次數

---

### E-2: 檔案系統錯誤

**錯誤類型：**
- **E-2.1:** 輸入檔案不存在
- **E-2.2:** 檔案讀取權限不足
- **E-2.3:** 磁碟空間不足
- **E-2.4:** 無法寫入輸出檔案

**錯誤訊息範例：**
```
[E-2.1] 找不到檔案：content.txt
[E-2.2] 權限不足：無法讀取 config.yaml
[E-2.3] 磁碟空間不足：需要 500MB，剩餘 100MB
[E-2.4] 無法寫入：output/final_video.mp4
```

**處理流程：**
1. 驗證檔案路徑
2. 檢查權限
3. 檢查可用空間
4. 提示用戶修正

**用戶操作：**
- 確認檔案路徑正確
- 修改檔案權限
- 清理磁碟空間
- 檢查輸出目錄是否存在

---

### E-3: 配置錯誤

**錯誤類型：**
- **E-3.1:** YAML 格式錯誤
- **E-3.2:** 缺失必要欄位
- **E-3.3:** 參數值超出範圍
- **E-3.4:** 類型錯誤

**錯誤訊息範例：**
```
[E-3.1] YAML 格式錯誤：第 12 行，縮排不正確
[E-3.2] 缺失必要欄位：subtitle.font_size
[E-3.3] 參數超出範圍：subtitle.font_size=150（必須在 20-100 之間）
[E-3.4] 類型錯誤：subtitle.position 必須為字串，收到數字
```

**處理流程：**
1. 使用 YAML 解析器驗證格式
2. 使用 schema 驗證欄位
3. 檢查參數範圍
4. 提供詳細錯誤位置和建議

**用戶操作：**
- 修正 YAML 格式
- 添加缺失欄位
- 調整參數值
- 修正類型錯誤

---

### E-4: 內容錯誤

**錯誤類型：**
- **E-4.1:** 文字長度不符（< 500 或 > 10000 字）
- **E-4.2:** 文字編碼錯誤
- **E-4.3:** 腳本結構錯誤

**錯誤訊息範例：**
```
[E-4.1] 文字長度不符：350 字（最少 500 字）
[E-4.2] 文字編碼錯誤：無法解碼為 UTF-8
[E-4.3] 腳本結構錯誤：缺少 'segments' 欄位
```

**處理流程：**
1. 驗證文字長度
2. 檢測文字編碼
3. 驗證腳本結構
4. 提示用戶修正

**用戶操作：**
- 調整文字長度
- 轉換文字編碼為 UTF-8
- 修正腳本結構

---

### E-5: 渲染錯誤

**錯誤類型：**
- **E-5.1:** FFmpeg 執行失敗
- **E-5.2:** 音訊同步錯誤
- **E-5.3:** 字幕渲染錯誤
- **E-5.4:** 輸出影片損壞

**錯誤訊息範例：**
```
[E-5.1] FFmpeg 錯誤：找不到編碼器 'libx264'
[E-5.2] 音訊同步錯誤：影片時長 300 秒，音訊時長 305 秒
[E-5.3] 字幕渲染錯誤：無法載入字型檔案
[E-5.4] 輸出影片損壞：無法播放
```

**處理流程：**
1. 檢查 FFmpeg 安裝
2. 驗證音訊和影片時長
3. 檢查字型檔案
4. 驗證輸出檔案

**用戶操作：**
- 安裝 FFmpeg
- 檢查素材時長
- 提供正確的字型檔案
- 重新渲染

**重試機制：**
- 自動重試 1 次
- 失敗後提示用戶手動檢查

---

### E-6: 網路錯誤

**錯誤類型：**
- **E-6.1:** 連線超時
- **E-6.2:** DNS 解析失敗
- **E-6.3:** SSL 證書錯誤
- **E-6.4:** HTTP 狀態碼錯誤（400、401、403、500 等）

**錯誤訊息範例：**
```
[E-6.1] 連線超時：無法連接到 generativelanguage.googleapis.com
[E-6.2] DNS 解析失敗：找不到 stability.ai
[E-6.3] SSL 錯誤：證書無效
[E-6.4] HTTP 401：API 金鑰無效
```

**處理流程：**
1. 檢測網路連線
2. 自動重試（指數退避）
3. 記錄錯誤詳情
4. 提示用戶檢查網路

**用戶操作：**
- 檢查網路連線
- 檢查防火牆設定
- 檢查 DNS 設定
- 檢查 API 金鑰

**重試機制：**
- 指數退避：2秒、4秒、8秒
- 最多 3 次重試

---

## 非功能需求

### NFR-1: 效能需求

#### NFR-1.1: 回應時間
- **腳本生成：** < 3 分鐘（95th percentile）
- **語音合成：** < 2 分鐘（95th percentile）
- **圖片生成（15張）：** < 5 分鐘（並行處理）
- **虛擬主播生成：** < 3 分鐘（95th percentile）
- **影片渲染：** < 15 分鐘（1080p, 5分鐘影片）
- **封面生成：** < 1 分鐘
- **YouTube 上傳：** < 5 分鐘（150MB 影片）
- **總計：** < 25 分鐘（端到端）

**測試方法：**
- 使用標準測試內容（5000字）
- 測量每個階段的時間
- 記錄 95th percentile

**失敗情況：**
- 任一階段超過 2 倍預期時間：記錄警告
- 總時長超過 40 分鐘：視為效能異常

#### NFR-1.2: 並發處理
- **素材生成：** 最多 4 個並行任務
- **影片片段處理：** 15 個片段並行處理
- **批次處理：** 支援佇列管理，一次處理一個專案

**測試方法：**
- 同時啟動 4 個素材生成任務
- 驗證資源使用率（CPU < 90%，記憶體 < 8GB）

#### NFR-1.3: 資料量限制
- **單一影片：** 最多 10 分鐘（600秒）
- **輸入文字：** 最多 10000 字
- **圖片數量：** 15 張
- **輸出檔案：** < 300MB

---

### NFR-2: 安全需求

#### NFR-2.1: 認證與授權
- **API 金鑰管理：**
  - 不允許硬編碼金鑰
  - 必須使用環境變數或安全儲存
  - 金鑰不得出現在日誌中
  - 支援金鑰輪換

**測試方法：**
- 掃描程式碼確保無硬編碼金鑰
- 驗證日誌檔案不包含敏感資訊

#### NFR-2.2: 資料保護
- **用戶內容：**
  - 本地處理，不上傳到第三方（除必要 API）
  - 支援刪除所有中間檔案
  - 不記錄敏感內容到日誌

- **API 通訊：**
  - 必須使用 HTTPS
  - 驗證 SSL 證書
  - 不使用過時的加密協議

**測試方法：**
- 驗證所有 API 呼叫使用 HTTPS
- 檢查日誌檔案不包含完整內容

#### NFR-2.3: 輸入驗證
- **文字內容：**
  - 驗證長度（500-10000 字）
  - 檢查字元編碼（UTF-8）
  - 過濾潛在危險字元（如 SQL injection）

- **配置檔案：**
  - 使用 schema 驗證
  - 檢查參數範圍
  - 拒絕未知參數（可選）

**測試方法：**
- 使用極端輸入（空字串、超長字串、特殊字元）
- 驗證系統正確拒絕

#### NFR-2.4: 防護措施
- **速率限制：**
  - 防止過度使用 API 配額
  - 批次處理前檢查配額

- **錯誤處理：**
  - 不洩漏系統資訊（路徑、版本等）
  - 錯誤訊息對用戶友善，對開發者詳細

**測試方法：**
- 模擬配額不足情況
- 驗證錯誤訊息不包含敏感資訊

---

### NFR-3: 可用性需求

#### NFR-3.1: 系統可用性
- **目標可用性：** > 99%（排除計畫性維護）
- **API 依賴：** 當外部 API 不可用時，系統應能偵測並提示
- **降級策略：**
  - D-ID 不可用：跳過虛擬主播，使用純音訊 + 圖片
  - 圖片生成部分失敗：使用佔位圖或跳過

**測試方法：**
- 模擬 API 不可用
- 驗證系統能夠優雅降級

#### NFR-3.2: 備份與恢復
- **進度保存：**
  - 每個階段完成後自動保存
  - 支援從任意階段恢復
  - 保存狀態檔案（project_state.json）

- **資料備份：**
  - 用戶負責備份配置和模板
  - 系統提供匯出功能

**測試方法：**
- 中斷生成流程
- 驗證可成功恢復

#### NFR-3.3: 錯誤監控
- **日誌記錄：**
  - 所有錯誤記錄到日誌檔案
  - 日誌包含時間戳、錯誤類型、詳細訊息
  - 日誌分級（DEBUG、INFO、WARNING、ERROR）

- **警報機制：**
  - API 配額 < 10%：警告
  - 連續失敗 > 3 次：警告
  - 磁碟空間 < 1GB：警告

**測試方法：**
- 觸發各類錯誤
- 驗證日誌正確記錄

---

### NFR-4: 可維護性需求

#### NFR-4.1: 程式碼品質
- **測試覆蓋率：**
  - 一般程式碼：> 80%
  - 核心業務邏輯：> 90%

- **程式碼規範：**
  - 遵循 PEP 8（Python）或相應語言規範
  - 使用 Linter（pylint、black 等）
  - 所有函數必須有 docstring

**測試方法：**
- 執行測試覆蓋率報告
- 執行 Linter 檢查

#### NFR-4.2: 文件化
- **程式碼文件：**
  - 所有公開函數必須有 docstring
  - 複雜邏輯必須有註解
  - 使用型別註解（Type Hints）

- **使用者文件：**
  - README 包含安裝和基本使用
  - 配置參考文件
  - 故障排除指南

**測試方法：**
- 審查程式碼確保文件完整
- 新用戶測試文件可用性

#### NFR-4.3: 部署
- **環境：**
  - 支援 Docker 部署
  - 支援虛擬環境（venv）
  - 依賴明確列出（requirements.txt）

- **版本管理：**
  - 遵循語義化版本（Semantic Versioning）
  - 每個 release 打 tag
  - Changelog 記錄變更

**測試方法：**
- 在乾淨環境中部署
- 驗證所有依賴正確安裝

---

### NFR-5: 相容性需求

#### NFR-5.1: 瀏覽器支援
- **不適用：** 本系統為 CLI 工具，無瀏覽器需求

#### NFR-5.2: 作業系統支援
- **支援：**
  - macOS (10.15+)
  - Linux (Ubuntu 20.04+)
  - Windows 10/11（需 WSL 或原生支援）

- **依賴：**
  - Python 3.9+
  - FFmpeg 4.4+

**測試方法：**
- 在各作業系統上測試
- 驗證 FFmpeg 可正常執行

#### NFR-5.3: 第三方服務
- **API 版本：**
  - Google Gemini API: v1 或更高（支援 gemini-1.5-pro、gemini-1.5-flash）
  - Stability AI: 最新版本
  - D-ID: API v1
  - YouTube Data API: v3

- **向下相容：**
  - 配置檔案格式向下相容（minor version）
  - 提供遷移工具（major version）

**測試方法：**
- 使用舊版配置檔案
- 驗證系統可正確載入或提示升級

---

## 狀態管理

### SM-1: 專案狀態 (Project State)

**狀態定義：**
- `INITIALIZED`: 專案已創建，等待開始
- `SCRIPT_GENERATING`: 腳本生成中
- `SCRIPT_GENERATED`: 腳本已生成
- `ASSETS_GENERATING`: 素材生成中（語音、圖片、虛擬主播）
- `ASSETS_GENERATED`: 所有素材已生成
- `RENDERING`: 影片渲染中
- `RENDERED`: 影片已渲染
- `THUMBNAIL_GENERATING`: 封面生成中
- `THUMBNAIL_GENERATED`: 封面已生成
- `UPLOADING`: 上傳中
- `COMPLETED`: 已完成
- `FAILED`: 失敗
- `PAUSED`: 暫停（用戶中斷或錯誤）

**狀態轉換圖：**
```
INITIALIZED
    ↓
SCRIPT_GENERATING
    ↓
SCRIPT_GENERATED
    ↓
ASSETS_GENERATING
    ↓
ASSETS_GENERATED
    ↓
RENDERING
    ↓
RENDERED
    ↓
THUMBNAIL_GENERATING
    ↓
THUMBNAIL_GENERATED
    ↓
UPLOADING
    ↓
COMPLETED

任何狀態 → FAILED（錯誤）
任何狀態 → PAUSED（用戶中斷）
PAUSED → 恢復到上一個狀態
```

**狀態轉換規則：**
- 只能從當前狀態轉換到下一個狀態
- 失敗或暫停可從任意狀態發生
- 恢復時從暫停前的狀態繼續

**儲存位置：**
- `project_state.json` 檔案
- 包含：當前狀態、已完成步驟、時間戳、錯誤訊息（如有）

---

### SM-2: 素材狀態 (Asset State)

**狀態定義：**
- `PENDING`: 等待生成
- `GENERATING`: 生成中
- `COMPLETED`: 已完成
- `FAILED`: 失敗

**適用素材：**
- 語音檔案（audio.mp3）
- 圖片檔案（image_01.png ~ image_15.png）
- 虛擬主播影片（intro_avatar.mp4, outro_avatar.mp4）
- 封面（thumbnail.jpg）

**狀態轉換圖：**
```
PENDING → GENERATING → COMPLETED
              ↓
            FAILED（重試或跳過）
```

**儲存位置：**
- `assets_state.json` 檔案
- 包含：每個素材的狀態、檔案路徑、生成時間

---

### SM-3: 批次任務狀態 (Batch State)

**狀態定義：**
- `QUEUED`: 在佇列中
- `RUNNING`: 執行中
- `COMPLETED`: 已完成
- `FAILED`: 失敗
- `SKIPPED`: 跳過（依賴任務失敗）

**狀態轉換圖：**
```
QUEUED → RUNNING → COMPLETED
            ↓
          FAILED
            ↓
         SKIPPED（後續任務）
```

**儲存位置：**
- `batch_state.json` 檔案
- 包含：所有任務的狀態、成功數量、失敗數量

---

### SM-4: YouTube 發布狀態

**狀態定義：**
- `NOT_UPLOADED`: 未上傳
- `UPLOADING`: 上傳中
- `UPLOADED`: 已上傳
- `SCHEDULED`: 已排程
- `PUBLISHED`: 已發布
- `UPLOAD_FAILED`: 上傳失敗

**狀態轉換圖：**
```
NOT_UPLOADED → UPLOADING → UPLOADED → PUBLISHED
                  ↓            ↓
            UPLOAD_FAILED   SCHEDULED → PUBLISHED
```

**儲存位置：**
- `youtube_state.json` 檔案
- 包含：影片 ID、發布狀態、排程時間（如有）

---

## 總結

### 流程統計
- **主要流程：** 10 個
  - Flow-0: 首次啟動設定流程（系統初始化）
  - Flow-1: 基本影片生成流程
  - Flow-2: 使用模板快速生成
  - Flow-3: 使用視覺化界面配置視覺元素
  - Flow-4: 排程發布影片
  - Flow-5: 批次處理多個影片
  - Flow-6: 斷點續傳與錯誤恢復
  - Flow-7: 段落級配置覆寫
  - Flow-8: Prompt 範本管理
  - Flow-9: 系統設定管理（API Keys、YouTube 授權）

### 邊界情況統計
- **邊界情況：** 10 個
  - EC-1: 用戶中途離開
  - EC-2: 網路連線問題
  - EC-3: 並行處理資源衝突
  - EC-4: API 配額即將用盡
  - EC-5: 生成的腳本段落數不符
  - EC-6: 素材生成部分失敗
  - EC-7: 磁碟空間不足
  - EC-8: YouTube 上傳超時
  - EC-9: 虛擬主播 API 回傳時長不符
  - EC-10: 配置檔案中存在未知參數

### 錯誤類型統計
- **錯誤類型：** 6 大類，共 18 種
  - E-1: API 錯誤（4 種）
  - E-2: 檔案系統錯誤（4 種）
  - E-3: 配置錯誤（4 種）
  - E-4: 內容錯誤（3 種）
  - E-5: 渲染錯誤（4 種）
  - E-6: 網路錯誤（4 種）

### 非功能需求統計
- **非功能需求：** 5 大類
  - NFR-1: 效能需求（回應時間、並發、資料量）
  - NFR-2: 安全需求（認證、資料保護、輸入驗證、防護）
  - NFR-3: 可用性需求（系統可用性、備份、監控）
  - NFR-4: 可維護性需求（程式碼品質、文件、部署）
  - NFR-5: 相容性需求（作業系統、第三方服務）

### 狀態管理統計
- **狀態類型：** 4 種
  - SM-1: 專案狀態（13 個狀態）
  - SM-2: 素材狀態（4 個狀態）
  - SM-3: 批次任務狀態（5 個狀態）
  - SM-4: YouTube 發布狀態（6 個狀態）

### 需要釐清的問題
無。所有核心功能都已在 overview.md 中清楚定義，流程設計完整且一致。
