# Issue-008: æ¸¬è©¦ç­–ç•¥å­˜åœ¨åš´é‡ç¼ºé™· - ç¼ºå°‘å‰å¾Œç«¯ API æ•´åˆæ¸¬è©¦

> **å»ºç«‹æ—¥æœŸï¼š** 2025-10-22
> **ç‹€æ…‹ï¼š** ğŸ”´ Open
> **å„ªå…ˆç´šï¼š** P0 ç·Šæ€¥
> **åˆ†é¡ï¼š** Testing / Architecture Flaw
> **è² è²¬äººï¼š** Claude
> **è§¸ç™¼åŸå› ï¼š** Issue-007 (Gemini API Key æ¸¬è©¦å¤±æ•—) æš´éœ²æ¸¬è©¦ç›²é»

---

## å•é¡Œæè¿°

### ç°¡è¿°
Task-029 çš„æ¸¬è©¦è¦åŠƒå­˜åœ¨**æ ¹æœ¬æ€§æ¶æ§‹ç¼ºé™·**ï¼šåªæ¸¬è©¦äº†ä½¿ç”¨è€…æµç¨‹ (E2E User Flow)ï¼Œå®Œå…¨å¿½ç•¥äº†å‰å¾Œç«¯ API æ•´åˆæ¸¬è©¦ï¼Œå°è‡´é€£æœ€åŸºæœ¬çš„**å‰å¾Œç«¯æ¬„ä½å‘½åä¸ä¸€è‡´** (`apiKey` vs `api_key`) éƒ½ç„¡æ³•æ•æ‰ã€‚

### åš´é‡æ€§è©•ä¼°
é€™ä¸æ˜¯ä¸€å€‹å°å•é¡Œï¼Œè€Œæ˜¯**æ•´å€‹æ¸¬è©¦ç­–ç•¥çš„çµæ§‹æ€§ç¼ºé™·**ï¼š

1. **Issue-007 æœ¬ä¸æ‡‰è©²ç™¼ç”Ÿ**
   - å‰ç«¯å‚³é€ï¼š`{provider: "gemini", apiKey: "..."}`
   - å¾Œç«¯æœŸå¾…ï¼š`{provider: "gemini", api_key: "..."}`
   - é€™ç¨®åŸºç¤å•é¡Œæ‡‰è©²åœ¨ç¬¬ä¸€æ¬¡è·‘æ¸¬è©¦æ™‚å°±è¢«ç™¼ç¾

2. **ç¾æœ‰æ¸¬è©¦çµ¦äº†è™›å‡çš„ä¿¡å¿ƒ**
   - Task-029 å®£ç¨±ã€Œæ•´é«”æ¸¬è©¦è¦†è“‹ç‡ > 90%ã€
   - ä½†é€£å‰å¾Œç«¯ API å‘¼å«éƒ½æ²’æ¸¬è©¦
   - é€™å€‹ 90% åªæ˜¯**ç¨‹å¼ç¢¼è¡Œæ•¸è¦†è“‹ç‡**ï¼Œä¸æ˜¯**åŠŸèƒ½è¦†è“‹ç‡**

3. **å•é¡Œå¯èƒ½ä¸åªé€™ä¸€å€‹**
   - å¦‚æœ API Key æ¸¬è©¦æœ‰å•é¡Œï¼Œå…¶ä»– API å‘¢ï¼Ÿ
   - `POST /api/v1/projects`ã€`POST /api/v1/scripts/generate` éƒ½å°å—ï¼Ÿ
   - **æˆ‘å€‘æ ¹æœ¬ä¸çŸ¥é“**

---

## ç¾æœ‰æ¸¬è©¦è¦åŠƒçš„ç¼ºé™·åˆ†æ

### Task-029 å¯¦éš›æ¸¬è©¦äº†ä»€éº¼ï¼Ÿ

è®“æˆ‘å€‘æª¢è¦– Task-029 çš„æ¸¬è©¦å…§å®¹ï¼š

#### Task-029A: æ¸¬è©¦åŸºç¤è¨­æ–½
```typescript
// åª Mock äº†ç¬¬ä¸‰æ–¹ API (Gemini, Stability AI, D-ID, YouTube)
// âŒ æ²’æœ‰æ¸¬è©¦ã€Œå‰ç«¯ â†’ å¾Œç«¯ã€çš„ API å‘¼å«
```

**å•é¡Œï¼š** Mock äº†æ‰€æœ‰ç¬¬ä¸‰æ–¹ APIï¼Œä½†**æ²’æœ‰æ¸¬è©¦æˆ‘å€‘è‡ªå·±çš„ API**ã€‚

#### Task-029B: æ ¸å¿ƒæµç¨‹æ¸¬è©¦
```
æ¸¬è©¦å…§å®¹ï¼š
- Flow-0: é¦–æ¬¡è¨­å®šæµç¨‹ (å¡«è¡¨å–® â†’ çœ‹åˆ°æˆåŠŸè¨Šæ¯)
- Flow-1: å½±ç‰‡ç”Ÿæˆæµç¨‹ (è¼¸å…¥å…§å®¹ â†’ çœ‹åˆ°å½±ç‰‡ç”Ÿæˆ)
```

**å•é¡Œï¼š** æ¸¬è©¦çš„æ˜¯ã€Œä½¿ç”¨è€…çœ‹åˆ°çš„çµæœã€ï¼Œä¸æ˜¯ã€ŒAPI å‘¼å«æ˜¯å¦æ­£ç¢ºã€ã€‚

**å¯¦éš›æ¸¬è©¦å±¤ç´šï¼š**
```
ä½¿ç”¨è€… â†’ å‰ç«¯ UI â†’ [âŒ æ²’æ¸¬é€™è£¡] â†’ å¾Œç«¯ API â†’ [âœ… æœ‰ Mock] â†’ ç¬¬ä¸‰æ–¹ API
```

### ç‚ºä»€éº¼ Issue-007 æ²’è¢«æ•æ‰ï¼Ÿ

**å ´æ™¯é‚„åŸï¼š**

1. **å‰ç«¯å–®å…ƒæ¸¬è©¦ (æ²’æœ‰)**
   ```typescript
   // frontend/tests/api/systemApi.test.ts - ä¸å­˜åœ¨ï¼
   // å¦‚æœæœ‰ï¼Œæ‡‰è©²æ¸¬è©¦ï¼š
   describe('systemApi.saveApiKey', () => {
     it('should send correct request body format', () => {
       // æ¸¬è©¦æœƒç™¼ç¾ï¼šå‚³é€çš„æ˜¯ apiKey è€Œé api_key
     })
   })
   ```

2. **å¾Œç«¯å–®å…ƒæ¸¬è©¦ (æœ‰ï¼Œä½†åªæ¸¬å¾Œç«¯å…§éƒ¨)**
   ```python
   # backend/tests/api/test_system.py:34-36
   response = client.post("/api/v1/system/api-keys", json={
       "provider": "gemini",
       "api_key": "AIza..."  # âœ… ç›´æ¥ç”¨æ­£ç¢ºæ ¼å¼ï¼Œæ‰€ä»¥æ¸¬è©¦é€šé
   })
   ```
   **å•é¡Œï¼š** æ¸¬è©¦ç”¨çš„æ˜¯ Python dict (snake_case)ï¼Œç•¶ç„¶é€šéï¼æ²’æ¸¬è©¦ã€Œå‰ç«¯å‚³ä¾†çš„ JSON æ˜¯å¦æ­£ç¢ºã€ã€‚

3. **E2E æ¸¬è©¦ (Task-029ï¼Œæœ‰ï¼Œä½†æ²’æ¸¬é€™æ®µ)**
   ```typescript
   // tests/e2e/setup-flow.spec.ts (å‡è¨­)
   // æ¸¬è©¦äº†ã€Œä½¿ç”¨è€…èƒ½å®Œæˆè¨­å®šã€
   // âŒ ä½†æ²’æ¸¬è©¦ã€ŒAPI å‘¼å«æ˜¯å¦ç”¨æ­£ç¢ºæ ¼å¼ã€
   ```

**çµè«–ï¼š** ä¸‰å±¤æ¸¬è©¦éƒ½æ²’æœ‰çœŸæ­£æ¸¬è©¦ã€Œå‰ç«¯ JavaScript å‚³é€çµ¦å¾Œç«¯ Python çš„ JSON æ ¼å¼ã€ã€‚

---

## ç¼ºå°‘çš„æ¸¬è©¦é¡å‹

### 1. å‰ç«¯ API Client å–®å…ƒæ¸¬è©¦

**ç›®å‰ç‹€æ…‹ï¼š** å®Œå…¨ç¼ºå¤±

**æ‡‰è©²æœ‰ï¼š**
```typescript
// frontend/tests/api/systemApi.test.ts
import { systemApi } from '@/services/api/systemApi'
import { apiClient } from '@/services/api/client'

jest.mock('@/services/api/client')

describe('systemApi.testApiKey', () => {
  it('should send correct request format', async () => {
    const mockPost = jest.spyOn(apiClient, 'post')

    await systemApi.testApiKey({
      provider: 'gemini',
      apiKey: 'test-key'  // å‰ç«¯ç”¨ camelCase
    })

    // é©—è­‰å‘¼å«æ™‚æ˜¯å¦è½‰æ›æˆ snake_case
    expect(mockPost).toHaveBeenCalledWith(
      '/api/v1/system/api-keys/test',
      {
        provider: 'gemini',
        api_key: 'test-key'  // âœ… æ‡‰è©²è½‰æ›
      }
    )
  })
})
```

**ä½œç”¨ï¼š** æ•æ‰ Issue-007 é¡å‹çš„å•é¡Œã€‚

---

### 2. API å¥‘ç´„æ¸¬è©¦ (Contract Testing)

**ç›®å‰ç‹€æ…‹ï¼š** å®Œå…¨ç¼ºå¤±

**æ‡‰è©²æœ‰ï¼š** ä½¿ç”¨ Pact æˆ–é¡ä¼¼å·¥å…·

```typescript
// frontend/tests/contract/system-api.contract.test.ts
import { pactWith } from 'jest-pact'

pactWith({ consumer: 'Frontend', provider: 'Backend' }, (interaction) => {
  interaction('test API key', ({ provider, execute }) => {
    beforeEach(() => {
      // å®šç¾©å‰ç«¯æœŸå¾…å¾Œç«¯æ¥å—çš„æ ¼å¼
      provider
        .given('I have a valid API key')
        .uponReceiving('a request to test API key')
        .withRequest({
          method: 'POST',
          path: '/api/v1/system/api-keys/test',
          body: {
            provider: 'gemini',
            api_key: 'test-key'  // æ˜ç¢ºå®šç¾©æ ¼å¼
          }
        })
        .willRespondWith({
          status: 200,
          body: {
            success: true,
            data: {
              is_valid: true,
              message: 'é€£ç·šæˆåŠŸ'
            }
          }
        })
    })

    execute('should test API key successfully', async () => {
      const result = await systemApi.testApiKey({
        provider: 'gemini',
        apiKey: 'test-key'
      })
      expect(result.is_valid).toBe(true)
    })
  })
})
```

**ä½œç”¨ï¼š**
- å‰ç«¯å®šç¾©ã€Œæˆ‘æœŸå¾…å¾Œç«¯æ¥å—çš„æ ¼å¼ã€
- å¾Œç«¯é©—è­‰ã€Œæˆ‘çœŸçš„èƒ½æ¥å—é€™å€‹æ ¼å¼ã€
- å¦‚æœä¸ä¸€è‡´ï¼Œæ¸¬è©¦å¤±æ•—

---

### 3. å‰å¾Œç«¯æ•´åˆæ¸¬è©¦

**ç›®å‰ç‹€æ…‹ï¼š** éƒ¨åˆ†æœ‰ (E2E)ï¼Œä½†æ¸¬è©¦å±¤ç´šéŒ¯èª¤

**å•é¡Œï¼š**
```
ç¾æœ‰ E2E æ¸¬è©¦ï¼š
ä½¿ç”¨è€…è¼¸å…¥ API Key â†’ å‰ç«¯é€å‡º â†’ å¾Œç«¯è™•ç† â†’ é¡¯ç¤ºæˆåŠŸ

é€™æ˜¯ã€Œé»‘ç®±æ¸¬è©¦ã€ï¼Œåªæ¸¬è©¦æœ€çµ‚çµæœï¼Œä¸æ¸¬è©¦ä¸­é–“çš„ API å‘¼å«ã€‚
```

**æ‡‰è©²æœ‰ï¼š** API å±¤ç´šçš„æ•´åˆæ¸¬è©¦

```typescript
// frontend/tests/integration/system-api.integration.test.ts
describe('System API Integration', () => {
  let backendServer: Server

  beforeAll(async () => {
    // å•Ÿå‹•çœŸå¯¦çš„å¾Œç«¯æ¸¬è©¦ä¼ºæœå™¨
    backendServer = await startBackend({ port: 8001, database: 'test' })
  })

  afterAll(async () => {
    await backendServer.close()
  })

  it('should successfully test API key with correct format', async () => {
    // å‰ç«¯çœŸçš„å‘¼å«å¾Œç«¯
    const result = await systemApi.testApiKey({
      provider: 'gemini',
      apiKey: 'valid-test-key'  // å‰ç«¯æ ¼å¼
    })

    // é©—è­‰å¾Œç«¯çœŸçš„æ”¶åˆ°ä¸¦è™•ç†äº†
    expect(result.is_valid).toBe(true)
  })

  it('should fail when sending incorrect format', async () => {
    // æ•…æ„ç”¨éŒ¯èª¤æ ¼å¼æ¸¬è©¦
    const response = await fetch('http://localhost:8001/api/v1/system/api-keys/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        provider: 'gemini',
        apiKey: 'test'  // âŒ éŒ¯èª¤æ ¼å¼ï¼Œæ‡‰è©²ç”¨ api_key
      })
    })

    // æ‡‰è©²å¾—åˆ° 422 Validation Error
    expect(response.status).toBe(422)
  })
})
```

**ä½œç”¨ï¼š**
- çœŸå¯¦æ¸¬è©¦å‰å¾Œç«¯é€šè¨Š
- æ•æ‰æ¬„ä½å‘½åã€è³‡æ–™æ ¼å¼ã€HTTP status code ç­‰å•é¡Œ

---

### 4. HTTP Request/Response æ ¼å¼æ¸¬è©¦

**ç›®å‰ç‹€æ…‹ï¼š** å®Œå…¨ç¼ºå¤±

**æ‡‰è©²æœ‰ï¼š**
```typescript
// tests/integration/api-format.test.ts
describe('API Request/Response Format', () => {
  // æ¸¬è©¦æ‰€æœ‰ API çš„ request/response æ ¼å¼

  const apis = [
    {
      name: 'Test API Key',
      endpoint: '/api/v1/system/api-keys/test',
      method: 'POST',
      requestSchema: {
        provider: { type: 'string', enum: ['gemini', 'stability_ai', 'did'] },
        api_key: { type: 'string', minLength: 10 }
      },
      responseSchema: {
        success: { type: 'boolean' },
        data: {
          is_valid: { type: 'boolean' },
          message: { type: 'string' }
        }
      }
    },
    // ... æ‰€æœ‰å…¶ä»– API
  ]

  apis.forEach(api => {
    it(`${api.name} should match schema`, async () => {
      // é©—è­‰ request/response ç¬¦åˆ schema
    })
  })
})
```

---

## Task-029 åˆ°åº•æ¸¬è©¦äº†ä»€éº¼ï¼ŸçœŸç›¸æª¢è¦–

### å®£ç¨±çš„ç›®æ¨™
```
> æ•´é«”æ¸¬è©¦è¦†è“‹ç‡ > 90%
> æ ¸å¿ƒæ¥­å‹™é‚è¼¯è¦†è“‹ç‡ > 95%
> 8 å€‹æ ¸å¿ƒ User Flow çš„ E2E æ¸¬è©¦å…¨éƒ¨å¯¦ä½œä¸¦é€šé
```

### å¯¦éš›æ¸¬è©¦çš„ç¯„åœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä½¿ç”¨è€…å±¤ç´š (E2E)                                   â”‚
â”‚  âœ… Task-029 æ¸¬è©¦äº†é€™è£¡                            â”‚
â”‚  â”œâ”€ Flow-0: è¨­å®šæµç¨‹                               â”‚
â”‚  â”œâ”€ Flow-1: å½±ç‰‡ç”Ÿæˆæµç¨‹                           â”‚
â”‚  â””â”€ Flow-2 ~ Flow-9: å…¶ä»–æµç¨‹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‰ç«¯ API Client å±¤                                 â”‚
â”‚  âŒ å®Œå…¨æ²’æ¸¬è©¦                                      â”‚
â”‚  â””â”€ systemApi.testApiKey()                         â”‚
â”‚  â””â”€ systemApi.saveApiKey()                         â”‚
â”‚  â””â”€ projectsApi.createProject()                    â”‚
â”‚  â””â”€ ... æ‰€æœ‰å…¶ä»– API                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  HTTP é€šè¨Šå±¤                                        â”‚
â”‚  âŒ å®Œå…¨æ²’æ¸¬è©¦                                      â”‚
â”‚  â””â”€ Request Body æ ¼å¼ (camelCase? snake_case?)    â”‚
â”‚  â””â”€ Response Body æ ¼å¼                             â”‚
â”‚  â””â”€ HTTP Status Code                               â”‚
â”‚  â””â”€ Error Handling                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¾Œç«¯ API å±¤                                        â”‚
â”‚  âœ… æœ‰æ¸¬è©¦ (ä½†åªç”¨ Python æ ¼å¼)                    â”‚
â”‚  â””â”€ test_system.py                                 â”‚
â”‚  â””â”€ test_projects.py                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ä¸‰æ–¹ API å±¤                                      â”‚
â”‚  âœ… Task-029A Mock äº†                              â”‚
â”‚  â””â”€ Gemini, Stability AI, D-ID, YouTube           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çµè«–ï¼š** åªæ¸¬è©¦äº†ã€Œä½¿ç”¨è€…çœ‹åˆ°çš„æµç¨‹ã€å’Œã€Œå¾Œç«¯å…§éƒ¨é‚è¼¯ã€ï¼Œ**å®Œå…¨è·³éäº†å‰å¾Œç«¯é€šè¨Šå±¤**ã€‚

### 90% æ¸¬è©¦è¦†è“‹ç‡çš„çœŸç›¸

**å®ƒæ¸¬è©¦çš„æ˜¯ï¼š**
- 90% çš„ç¨‹å¼ç¢¼è¡Œæ•¸è¢«åŸ·è¡Œé
- 90% çš„ä½¿ç”¨è€…æµç¨‹å¯ä»¥èµ°å®Œ

**å®ƒæ²’æ¸¬è©¦çš„æ˜¯ï¼š**
- å‰å¾Œç«¯ API å‘¼å«æ ¼å¼æ˜¯å¦æ­£ç¢º
- HTTP request/response æ˜¯å¦ç¬¦åˆè¦ç¯„
- éŒ¯èª¤è™•ç†æ˜¯å¦å®Œæ•´

**æ¯”å–»ï¼š**
```
å°±åƒæ¸¬è©¦ä¸€è¼›è»Šï¼š
âœ… æ¸¬è©¦äº†ã€Œè»Šå­èƒ½å¾ A é–‹åˆ° Bã€(E2E)
âœ… æ¸¬è©¦äº†ã€Œå¼•æ“èƒ½æ­£å¸¸é‹è½‰ã€(å¾Œç«¯å–®å…ƒæ¸¬è©¦)
âŒ ä½†æ²’æ¸¬è©¦ã€Œæ–¹å‘ç›¤å’Œè¼ªèƒçš„é€£æ¥æ˜¯å¦æ­£ç¢ºã€(å‰å¾Œç«¯æ•´åˆ)

çµæœï¼šè»Šå­èƒ½é–‹ï¼Œä½†è½‰å½æ™‚æ–¹å‘ç›¤å¯èƒ½ä¸éˆã€‚
```

---

## ç‚ºä»€éº¼æœƒç™¼ç”Ÿé€™å€‹å•é¡Œï¼Ÿæ ¹å› åˆ†æ

### 1. æ¸¬è©¦é‡‘å­—å¡”ç†è§£éŒ¯èª¤

**æ­£ç¢ºçš„æ¸¬è©¦é‡‘å­—å¡”ï¼š**
```
       E2E (10%)
      /         \
     /           \
    / Integration \
   /    (30%)      \
  /                 \
 /   Unit (60%)      \
/_____________________\
```

**æˆ‘å€‘å¯¦éš›åšçš„ï¼š**
```
       E2E (60%)
      /         \
     /           \
    / Unit (40%)  \
   /               \
  /                 \
 /  Integration (0%) \
/_____________________\
```

**å•é¡Œï¼š** å®Œå…¨å¿½ç•¥äº† Integration Testing é€™ä¸€å±¤ã€‚

### 2. E2E æ¸¬è©¦å®šç¾©éŒ¯èª¤

**æˆ‘å€‘ä»¥ç‚ºçš„ E2Eï¼š**
- ã€Œç«¯åˆ°ç«¯ã€= å¾ä½¿ç”¨è€…è¼¸å…¥åˆ°çœ‹åˆ°çµæœ

**å¯¦éš›æ‡‰è©²çš„ E2Eï¼š**
- ã€Œç«¯åˆ°ç«¯ã€= å¾å‰ç«¯ â†’ HTTP â†’ å¾Œç«¯ â†’ Database â†’ ç¬¬ä¸‰æ–¹ API â†’ è¿”å›

**å•é¡Œï¼š** æˆ‘å€‘åªæ¸¬è©¦äº†ã€Œä½¿ç”¨è€…é«”é©—ã€ï¼Œæ²’æ¸¬è©¦ã€Œç³»çµ±æ•´åˆã€ã€‚

### 3. Mock ç­–ç•¥éŒ¯èª¤

**æ­£ç¢ºçš„ Mock ç­–ç•¥ï¼š**
```
Unit Test:     Mock æ‰€æœ‰å¤–éƒ¨ä¾è³´
Integration:   Mock ç¬¬ä¸‰æ–¹ APIï¼Œä¸ Mock è‡ªå·±çš„ API
E2E:           Mock ç¬¬ä¸‰æ–¹ APIï¼Œæ¸¬è©¦å®Œæ•´æµç¨‹
```

**æˆ‘å€‘çš„ Mock ç­–ç•¥ï¼š**
```
Unit Test:     âœ… Mock å¤–éƒ¨ä¾è³´
Integration:   âŒ ä¸å­˜åœ¨
E2E:           âœ… Mock ç¬¬ä¸‰æ–¹ APIï¼Œä½†æ²’æ¸¬è©¦å‰å¾Œç«¯é€šè¨Š
```

### 4. æ¸¬è©¦è¦†è“‹ç‡æŒ‡æ¨™èª¤å°

**Code Coverage ä¸ç­‰æ–¼ Feature Coverage**

```python
# é€™æ®µç¨‹å¼ç¢¼æœ‰ 100% coverage
@router.post("/api-keys")
async def save_api_key(data: APIKeyRequest):
    await service.save_api_key(data.provider, data.api_key)
    return {"success": True}

# æ¸¬è©¦ï¼š
def test_save_api_key():
    response = client.post("/api-keys", json={
        "provider": "gemini",
        "api_key": "test"
    })
    assert response.status_code == 200

# âœ… Code Coverage: 100%
# âŒ ä½†æ²’æ¸¬è©¦ã€Œå‰ç«¯å‚³ä¾†çš„ apiKey æœƒä¸æœƒå°è‡´ 422ã€
```

---

## æ¸¬è©¦ç­–ç•¥é‡æ–°è¦åŠƒ

### çŸ­æœŸä¿®å¾© (ç«‹å³åŸ·è¡Œ)

#### 1. æ–°å¢å‰ç«¯ API Client æ¸¬è©¦

**æª”æ¡ˆï¼š** `frontend/tests/api/systemApi.test.ts`

**ç›®æ¨™ï¼š** æ¸¬è©¦æ‰€æœ‰ API client å‡½æ•¸

**é ä¼°æ™‚é–“ï¼š** 4 å°æ™‚

**ç¯„åœï¼š**
- systemApi (5 å€‹ API)
- projectsApi (10+ å€‹ API)
- scriptsApi (5 å€‹ API)
- å…¶ä»–æ‰€æœ‰ API

**æ¸¬è©¦å…§å®¹ï¼š**
- Request body æ ¼å¼æ­£ç¢º
- Response handling æ­£ç¢º
- Error handling æ­£ç¢º

#### 2. æ›´æ–°ç¾æœ‰å¾Œç«¯æ¸¬è©¦

**ç›®æ¨™ï¼š** æ¸¬è©¦ã€Œå‰ç«¯å¯èƒ½å‚³ä¾†çš„éŒ¯èª¤æ ¼å¼ã€

**ç¯„ä¾‹ï¼š**
```python
def test_save_api_key_with_camelcase_should_fail():
    """æ¸¬è©¦å‰ç«¯éŒ¯èª¤å‚³é€ camelCase æ™‚æ‡‰è©²å›å‚³ 422"""
    response = client.post("/api/v1/system/api-keys", json={
        "provider": "gemini",
        "apiKey": "test"  # âŒ éŒ¯èª¤æ ¼å¼
    })
    assert response.status_code == 422
```

**é ä¼°æ™‚é–“ï¼š** 2 å°æ™‚

#### 3. æ–°å¢ API æ•´åˆæ¸¬è©¦ (Setup Flow å°ˆç”¨)

**æª”æ¡ˆï¼š** `frontend/tests/integration/setup-flow-api.test.ts`

**ç›®æ¨™ï¼š** æ¸¬è©¦ setup æµç¨‹çš„æ‰€æœ‰ API å‘¼å«

**é ä¼°æ™‚é–“ï¼š** 3 å°æ™‚

---

### ä¸­æœŸæ”¹å–„ (æœ¬é€±å®Œæˆ)

#### 4. å¯¦ä½œ API å¥‘ç´„æ¸¬è©¦

**å·¥å…·ï¼š** Pact æˆ– Dredd

**ç›®æ¨™ï¼š** å‰å¾Œç«¯ API æ ¼å¼è‡ªå‹•é©—è­‰

**é ä¼°æ™‚é–“ï¼š** 8 å°æ™‚

#### 5. æ–°å¢å‰å¾Œç«¯æ•´åˆæ¸¬è©¦å¥—ä»¶

**ç›®æ¨™ï¼š** æ‰€æœ‰é‡è¦ API éƒ½æœ‰æ•´åˆæ¸¬è©¦

**é ä¼°æ™‚é–“ï¼š** 12 å°æ™‚

---

### é•·æœŸæ”¹å–„ (ä¸‹å€‹ Sprint)

#### 6. è‡ªå‹•ç”Ÿæˆ API Types

**å·¥å…·ï¼š** OpenAPI + openapi-typescript

**æµç¨‹ï¼š**
```
å¾Œç«¯ FastAPI â†’ è‡ªå‹•ç”Ÿæˆ openapi.json
             â†’ è‡ªå‹•ç”Ÿæˆ TypeScript types
             â†’ å‰ç«¯ä½¿ç”¨é€™äº› types
```

**å¥½è™•ï¼š**
- å‰å¾Œç«¯ interface è‡ªå‹•åŒæ­¥
- TypeScript æœƒåœ¨ç·¨è­¯æ™‚æ•æ‰æ¬„ä½éŒ¯èª¤

**é ä¼°æ™‚é–“ï¼š** 16 å°æ™‚

#### 7. CI/CD åŠ å…¥ Contract Testing

**ç›®æ¨™ï¼š** æ¯æ¬¡ PR éƒ½è‡ªå‹•é©—è­‰ API å¥‘ç´„

**é ä¼°æ™‚é–“ï¼š** 4 å°æ™‚

---

## ç«‹å³è¡Œå‹•è¨ˆåŠƒ (æœ¬æ¬¡å°è©±)

### Step 1: æ–°å¢å‰ç«¯ API æ¸¬è©¦ (systemApi)

**ç¯„åœï¼š** åªæ¸¬è©¦ `systemApi.ts` (å…ˆä¿®å¾© Issue-007 çš„å•é¡Œ)

**æª”æ¡ˆï¼š**
- `frontend/tests/api/systemApi.test.ts`

**æ¸¬è©¦æ¡ˆä¾‹ï¼š**
1. `testApiKey()` æ‡‰è©²å‚³é€æ­£ç¢ºæ ¼å¼
2. `saveApiKey()` æ‡‰è©²å‚³é€æ­£ç¢ºæ ¼å¼
3. `getApiKeysStatus()` æ‡‰è©²æ­£ç¢ºè§£æå›æ‡‰

**é ä¼°æ™‚é–“ï¼š** 1 å°æ™‚

### Step 2: æ›´æ–°å¾Œç«¯æ¸¬è©¦

**æª”æ¡ˆï¼š** `backend/tests/api/test_system.py`

**æ–°å¢æ¸¬è©¦ï¼š**
1. æ¸¬è©¦å‚³é€ `apiKey` (éŒ¯èª¤) æ‡‰è©²å›å‚³ 422
2. æ¸¬è©¦å‚³é€ `api_key` (æ­£ç¢º) æ‡‰è©²å›å‚³ 200

**é ä¼°æ™‚é–“ï¼š** 30 åˆ†é˜

### Step 3: æ–°å¢ç°¡å–®çš„æ•´åˆæ¸¬è©¦

**æª”æ¡ˆï¼š** `tests/integration/system-api.integration.test.ts`

**æ¸¬è©¦ï¼š** å‰ç«¯çœŸçš„å‘¼å«å¾Œç«¯ (ä½¿ç”¨æ¸¬è©¦è³‡æ–™åº«)

**é ä¼°æ™‚é–“ï¼š** 1.5 å°æ™‚

---

## æˆåŠŸæ¨™æº–

### çŸ­æœŸç›®æ¨™ (æœ¬æ¬¡ä¿®å¾©)
- [ ] systemApi çš„æ‰€æœ‰å‡½æ•¸éƒ½æœ‰å–®å…ƒæ¸¬è©¦
- [ ] å¾Œç«¯æ¸¬è©¦æ¶µè“‹ã€Œå‰ç«¯å¯èƒ½å‚³ä¾†çš„éŒ¯èª¤æ ¼å¼ã€
- [ ] è‡³å°‘æœ‰ä¸€å€‹çœŸå¯¦çš„å‰å¾Œç«¯æ•´åˆæ¸¬è©¦
- [ ] Issue-007 é¡å‹çš„å•é¡Œèƒ½è¢«æ¸¬è©¦æ•æ‰

### ä¸­æœŸç›®æ¨™ (æœ¬é€±)
- [ ] æ‰€æœ‰ API Client éƒ½æœ‰å–®å…ƒæ¸¬è©¦
- [ ] API å¥‘ç´„æ¸¬è©¦æ©Ÿåˆ¶å»ºç«‹
- [ ] CI/CD åŸ·è¡Œæ–°çš„æ¸¬è©¦

### é•·æœŸç›®æ¨™ (ä¸‹å€‹ Sprint)
- [ ] OpenAPI è‡ªå‹•ç”Ÿæˆ Types
- [ ] å‰å¾Œç«¯ interface è‡ªå‹•åŒæ­¥
- [ ] æ•´é«”æ¸¬è©¦è¦†è“‹ç‡ > 90% (çœŸæ­£çš„åŠŸèƒ½è¦†è“‹ï¼Œä¸åªæ˜¯è¡Œæ•¸)

---

## å­¸ç¿’èˆ‡åæ€

### é€™æ¬¡å¤±æ•—æ•™æœƒæˆ‘å€‘ä»€éº¼ï¼Ÿ

1. **Code Coverage æ˜¯è™›å‡æŒ‡æ¨™**
   - ä¸èƒ½åªçœ‹è¡Œæ•¸è¦†è“‹ç‡
   - è¦çœ‹ã€ŒåŠŸèƒ½é»ã€æ˜¯å¦çœŸçš„è¢«æ¸¬è©¦

2. **E2E æ¸¬è©¦ä¸æ˜¯è¬èƒ½çš„**
   - E2E æ¸¬è©¦æˆæœ¬é«˜ã€é€Ÿåº¦æ…¢
   - æ‡‰è©²ç”¨ Integration Testing è£œå……

3. **Mock è¦é©åº¦**
   - ä¸èƒ½ Mock æ‰ã€Œä½ æƒ³æ¸¬è©¦çš„éƒ¨åˆ†ã€
   - æˆ‘å€‘ Mock æ‰äº†ç¬¬ä¸‰æ–¹ API (æ­£ç¢º)
   - ä½†ä¹Ÿã€Œè·³éã€äº†å‰å¾Œç«¯é€šè¨Š (éŒ¯èª¤)

4. **æ¸¬è©¦é‡‘å­—å¡”è¦å¹³è¡¡**
   - Unit: 60% (å¿«é€Ÿã€å¤§é‡)
   - Integration: 30% (é‡è¦æ¥å£)
   - E2E: 10% (é—œéµæµç¨‹)

5. **å‰å¾Œç«¯åˆ†é›¢éœ€è¦å¥‘ç´„**
   - éœ€è¦æ˜ç¢ºå®šç¾© API æ ¼å¼
   - éœ€è¦è‡ªå‹•åŒ–é©—è­‰

---

## é™„éŒ„ï¼šå®Œæ•´æ¸¬è©¦ç­–ç•¥å°æ¯”

### Before (Task-029 çš„è¦åŠƒ)
```
æ¸¬è©¦é¡å‹         æ•¸é‡    æ¯”ä¾‹    èªªæ˜
Unit Tests       50+     40%     å¾Œç«¯å–®å…ƒæ¸¬è©¦
E2E Tests        8       60%     ä½¿ç”¨è€…æµç¨‹æ¸¬è©¦
Integration      0       0%      âŒ å®Œå…¨ç¼ºå¤±
Contract Tests   0       0%      âŒ å®Œå…¨ç¼ºå¤±
API Client Tests 0       0%      âŒ å®Œå…¨ç¼ºå¤±
```

### After (æ”¹å–„å¾Œçš„è¦åŠƒ)
```
æ¸¬è©¦é¡å‹             æ•¸é‡    æ¯”ä¾‹    èªªæ˜
Unit Tests           100+    50%     å‰å¾Œç«¯å–®å…ƒæ¸¬è©¦
API Client Tests     30+     10%     å‰ç«¯ API client
Integration Tests    40+     25%     å‰å¾Œç«¯æ•´åˆ
Contract Tests       20+     10%     API å¥‘ç´„æ¸¬è©¦
E2E Tests            8       5%      é—œéµä½¿ç”¨è€…æµç¨‹
```

---

## ç›¸é—œ Issue
- Issue-007: Gemini API Key æ¸¬è©¦é€£ç·šå¤±æ•— (è§¸ç™¼åŸå› )

## ç›¸é—œ Task
- Task-029: E2E æ•´åˆæ¸¬è©¦ (éœ€è¦å¤§å¹…ä¿®æ­£)
- Task-029A/B/C/D: å­ä»»å‹™ (éœ€è¦è£œå……)

## åƒè€ƒè³‡æº
- [Testing Trophy](https://kentcdodds.com/blog/the-testing-trophy-and-testing-classifications)
- [Contract Testing](https://martinfowler.com/bliki/ContractTest.html)
- [Pact Documentation](https://docs.pact.io/)

---

## ç‹€æ…‹æ›´æ–°è¨˜éŒ„

| æ—¥æœŸ | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| 2025-10-22 | ğŸ”´ Open | å•é¡Œç™¼ç¾ï¼Œæ¸¬è©¦ç­–ç•¥å­˜åœ¨æ ¹æœ¬æ€§ç¼ºé™· |

---

æœ€å¾Œæ›´æ–°ï¼š2025-10-22
