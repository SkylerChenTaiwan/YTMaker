# [å·²è§£æ±º] Issue-001: éŒ¯èª¤è™•ç†èˆ‡ Fallback ç­–ç•¥å­˜åœ¨åš´é‡ç¼ºé™·

> **å»ºç«‹æ—¥æœŸï¼š** 2025-10-20
> **ç‹€æ…‹ï¼š** âœ… Resolved
> **å„ªå…ˆç´šï¼š** P0 ç·Šæ€¥
> **åˆ†é¡ï¼š** Design
> **è² è²¬äººï¼š** Skyler
> **è§£æ±ºæ—¥æœŸï¼š** 2025-10-20

---

## å•é¡Œæè¿°

### ç°¡è¿°
ç•¶å‰çš„éŒ¯èª¤è™•ç†èˆ‡ fallback ç­–ç•¥éæ–¼å¯¬å®¹ï¼Œæœƒéœé»˜åæ‰éŒ¯èª¤ï¼Œå°è‡´å•é¡Œé›£ä»¥å®šä½å’Œèª¿è©¦ï¼Œé•åã€Œå¤±æ•—é›¶å®¹å¿ã€å’Œã€Œè¼•é¬†å®šä½éŒ¯èª¤ã€çš„éœ€æ±‚ã€‚

### è©³ç´°èªªæ˜
åœ¨ spec review éç¨‹ä¸­ç™¼ç¾ï¼Œç¾æœ‰çš„éŒ¯èª¤è™•ç†è¨­è¨ˆå­˜åœ¨ä»¥ä¸‹åš´é‡å•é¡Œï¼š

1. **è‡ªå‹• Fallback æ©Ÿåˆ¶éæ–¼å¯¬å®¹**ï¼šè™›æ“¬ä¸»æ’­ç”Ÿæˆå¤±æ•—æ™‚æœƒéœé»˜é™ç´šï¼Œç”¨æˆ¶å’Œé–‹ç™¼è€…éƒ½ä¸çŸ¥é“ç™¼ç”Ÿäº†ä»€éº¼éŒ¯èª¤
2. **æ—¥èªŒç­–ç•¥ç¼ºä¹ç´°ç¯€**ï¼šæ²’æœ‰çµæ§‹åŒ–æ—¥èªŒã€æ²’æœ‰ Trace IDã€ç„¡æ³•å¿«é€Ÿå®šä½å•é¡Œ
3. **éŒ¯èª¤ç¢¼é«”ç³»ä¸å®Œæ•´**ï¼šç¼ºå°‘å¤§é‡éŒ¯èª¤æƒ…å¢ƒçš„å®šç¾©ï¼Œæ²’æœ‰æ¢å¾©æŒ‡å—
4. **å‰å¾Œç«¯éŒ¯èª¤è™•ç†ä¸ä¸€è‡´**ï¼šé‡è©¦ç­–ç•¥å’ŒéŒ¯èª¤è¨Šæ¯æ ¼å¼ä¸çµ±ä¸€
5. **ç¼ºå°‘æ˜ç¢ºçš„éŒ¯èª¤è³‡è¨Šè¨˜éŒ„**ï¼šProject è³‡æ–™è¡¨æ²’æœ‰ error_info æ¬„ä½ï¼Œå‰ç«¯ç„¡æ³•é¡¯ç¤ºè©³ç´°éŒ¯èª¤

### ç™¼ç¾æ™‚æ©Ÿ
- **éšæ®µï¼š** Spec Reviewï¼ˆé–‹ç™¼å‰æª¢æŸ¥ï¼‰
- **ä»»å‹™ï¼š** æº–å‚™é–‹å§‹ Phase 1 é–‹ç™¼
- **æª”æ¡ˆï¼š**
  - `tech-specs/backend/integrations.md`
  - `tech-specs/backend/business-logic.md`
  - `tech-specs/backend/overview.md`
  - `tech-specs/frontend/api-integration.md`
- **åŠŸèƒ½ï¼š** éŒ¯èª¤è™•ç†èˆ‡ç›£æ§

---

## ç’°å¢ƒè³‡è¨Š

**ç’°å¢ƒï¼š**
- éšæ®µï¼šè¨­è¨ˆéšæ®µï¼ˆå°šæœªé–‹ç™¼ï¼‰
- å½±éŸ¿ç¯„åœï¼šæ•´å€‹å¾Œç«¯å’Œå‰ç«¯çš„éŒ¯èª¤è™•ç†æ¶æ§‹

**ç›¸é—œç‰ˆæœ¬ï¼š**
- å°ˆæ¡ˆç‰ˆæœ¬/Commitï¼šç•¶å‰ spec ç‰ˆæœ¬
- ç›¸é—œæ–‡ä»¶ï¼šPhase 1 æ‰€æœ‰ tech specs

---

## å•é¡Œè©³ç´°åˆ†æ

### å•é¡Œ 1ï¼šè‡ªå‹• Fallback æ©Ÿåˆ¶éæ–¼å¯¬å®¹ï¼ˆé«˜é¢¨éšªï¼‰

**å•é¡Œä½ç½®ï¼š** `tech-specs/backend/integrations.md:243-252` å’Œ `tech-specs/backend/business-logic.md:238-246`

**ç¾æœ‰è¨­è¨ˆï¼š**
```python
def generate_avatar_with_fallback(audio_url, avatar_image_url):
    try:
        return generate_avatar_video(audio_url, avatar_image_url)
    except Exception as e:
        log_error(f"Avatar generation failed: {str(e)}")
        # é™ç´šï¼šä¸ä½¿ç”¨è™›æ“¬ä¸»æ’­,ç›´æ¥ä½¿ç”¨éŸ³è¨Š + åœ–ç‰‡
        return None
```

**å•é¡Œé»ï¼š**
- âŒ ç›´æ¥åæ‰æ‰€æœ‰ Exceptionï¼Œç„¡æ³•å€åˆ†éŒ¯èª¤é¡å‹
- âŒ `log_error` ä¸å¤ æ˜ç¢ºï¼Œç„¡æ³•å¿«é€Ÿå®šä½å•é¡Œ
- âŒ è¿”å› `None` å¾Œéœé»˜é™ç´šï¼Œå‰ç«¯å¯èƒ½å®Œå…¨ä¸çŸ¥é“å‡ºéŒ¯äº†
- âŒ æ²’æœ‰å€åˆ†**å¯é‡è©¦çš„éŒ¯èª¤**å’Œ**ä¸å¯é‡è©¦çš„éŒ¯èª¤**

**å¯¦éš›å½±éŸ¿ï¼š**
- D-ID API Key ç„¡æ•ˆ â†’ éœé»˜å¤±æ•— â†’ ç¹¼çºŒåŸ·è¡Œ â†’ èŠ±å¾ˆå¤šæ™‚é–“æ‰ç™¼ç¾æ˜¯ API Key å•é¡Œ
- ç¶²è·¯æš«æ™‚æ–·ç·š â†’ æ‡‰è©²é‡è©¦å»ç›´æ¥æ”¾æ£„ â†’ ç”¨æˆ¶ä¸çŸ¥é“ç‚ºä»€éº¼æ²’æœ‰è™›æ“¬ä¸»æ’­
- é…é¡ç”¨ç›¡ â†’ éœé»˜å¤±æ•— â†’ ç”¨æˆ¶ä»¥ç‚ºåŠŸèƒ½æ­£å¸¸ä½†å°±æ˜¯æ²’æœ‰è™›æ“¬ä¸»æ’­

---

### å•é¡Œ 2ï¼šåœ–ç‰‡ç”Ÿæˆçš„ Fallback ç­–ç•¥ä¸æ˜ç¢ºï¼ˆä¸­é¢¨éšªï¼‰

**å•é¡Œä½ç½®ï¼š** `tech-specs/backend/business-logic.md:102-103`

**ç¾æœ‰è¨­è¨ˆï¼š**
```
**éƒ¨åˆ†åœ–ç‰‡å¤±æ•—ï¼š**
- æ¨™è¨˜å¤±æ•—åœ–ç‰‡
- æä¾›é¸é …ï¼šä½¿ç”¨ä½”ä½åœ– / ç§»é™¤è©²æ®µè½
```

**å•é¡Œé»ï¼š**
- âŒ ã€Œæä¾›é¸é …ã€æ˜¯ä»€éº¼æ„æ€ï¼Ÿèª°ä¾†æ±ºå®šï¼Ÿå‰ç«¯ï¼Ÿè‡ªå‹•ï¼Ÿ
- âŒ å¦‚æœè‡ªå‹•ä½¿ç”¨ä½”ä½åœ–ï¼Œç”¨æˆ¶å¯èƒ½ä¸çŸ¥é“æœ‰åœ–ç‰‡å¤±æ•—
- âŒ å¦‚æœè‡ªå‹•ç§»é™¤æ®µè½ï¼Œå¯èƒ½ç ´å£è…³æœ¬é‚è¼¯

---

### å•é¡Œ 3ï¼šéŒ¯èª¤è™•ç†ç­–ç•¥ä¸ä¸€è‡´ï¼ˆä¸­é¢¨éšªï¼‰

**å•é¡Œä½ç½®ï¼š** `tech-specs/backend/integrations.md` å’Œ `tech-specs/frontend/api-integration.md`

**å¾Œç«¯ç­–ç•¥ï¼š**
```python
# 429 Rate Limitï¼šæŒ‡æ•¸é€€é¿ï¼Œæœ€å¤š 3 æ¬¡
# 400 Content Policyï¼šè¨˜éŒ„ Promptï¼Œå˜—è©¦ä¿®æ”¹å¾Œé‡è©¦
```

**å‰ç«¯ç­–ç•¥ï¼š**
```typescript
const handleApiError = (error: any) => {
  switch (status) {
    case 400:
      toast.error(data.error?.message || 'è«‹æ±‚åƒæ•¸éŒ¯èª¤')
      break
    case 500:
      toast.error('ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦')
      break
    default:
      toast.error(error.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤')
  }
}
```

**å•é¡Œé»ï¼š**
- âŒ å¾Œç«¯é‡è©¦ 3 æ¬¡ï¼Œä½†å‰ç«¯ä¸çŸ¥é“ï¼Œå¯èƒ½éæ—©é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
- âŒ å‰ç«¯åªé¡¯ç¤º toastï¼Œæ²’æœ‰è¨˜éŒ„åˆ°æ—¥èªŒï¼Œèª¿è©¦æ™‚æ‰¾ä¸åˆ°
- âŒ ã€ŒæœªçŸ¥éŒ¯èª¤ã€å¤ªæ¨¡ç³Šï¼Œå®Œå…¨ç„¡æ³•å®šä½

---

### å•é¡Œ 4ï¼šæ—¥èªŒç­–ç•¥ç¼ºä¹ç´°ç¯€ï¼ˆé«˜é¢¨éšªï¼‰

**å•é¡Œä½ç½®ï¼š** `tech-specs/backend/overview.md:248-253`

**ç¾æœ‰è¨­è¨ˆï¼š**
```
**æ—¥èªŒé…ç½®:**
- **ä½ç½®:** `logs/app.log`
- **ç­‰ç´š:** INFO (ç”Ÿç”¢), DEBUG (é–‹ç™¼)
- **è¼ªæ›¿:** æ¯æ—¥è¼ªæ›¿,ä¿ç•™ 30 å¤©
- **æ ¼å¼:** `[æ™‚é–“] [ç­‰ç´š] [æ¨¡çµ„] - è¨Šæ¯`
```

**å•é¡Œé»ï¼š**
- âŒ æ²’æœ‰å®šç¾©**å¿…é ˆè¨˜éŒ„ä»€éº¼**ï¼ˆAPI å‘¼å«ï¼Ÿåƒæ•¸ï¼Ÿå›æ‡‰ï¼Ÿï¼‰
- âŒ æ²’æœ‰ Request ID / Trace IDï¼Œå¤šå€‹ä¸¦è¡Œè«‹æ±‚æ™‚ç„¡æ³•è¿½è¹¤
- âŒ æ²’æœ‰çµæ§‹åŒ–æ—¥èªŒï¼ˆJSONï¼‰ï¼Œåªæœ‰ç´”æ–‡å­—ï¼Œé›£ä»¥æœå°‹å’Œåˆ†æ
- âŒ åªè¨˜éŒ„åœ¨æœ¬åœ°æª”æ¡ˆï¼Œæ²’æœ‰é›†ä¸­åŒ–æ—¥èªŒç³»çµ±

**å¯¦éš›å½±éŸ¿ï¼š**
- ç”¨æˆ¶èªªã€Œ10 åˆ†é˜å‰ç”Ÿæˆå¤±æ•—ã€â†’ è¦åœ¨å¹¾åƒè¡Œæ—¥èªŒä¸­æ‰‹å‹•æœå°‹
- æœ‰ 3 å€‹å°ˆæ¡ˆåŒæ™‚ç”Ÿæˆ â†’ æ—¥èªŒæ··åœ¨ä¸€èµ· â†’ ç„¡æ³•å€åˆ†å“ªå€‹å°ˆæ¡ˆçš„éŒ¯èª¤

---

### å•é¡Œ 5ï¼šç¼ºå°‘æ˜ç¢ºçš„éŒ¯èª¤ç¢¼é«”ç³»ï¼ˆé«˜é¢¨éšªï¼‰

**å•é¡Œä½ç½®ï¼š** `tech-specs/backend/api-design.md:65-80`

**ç¾æœ‰å®šç¾©ï¼š**
å®šç¾©äº†ä¸€äº›éŒ¯èª¤ç¢¼ï¼Œä½†ï¼š
- âŒ æ²’æœ‰æ¶µè“‹æ‰€æœ‰æƒ…å¢ƒï¼ˆä¾‹å¦‚ï¼šRedis é€£ç·šå¤±æ•—ã€FFmpeg åŸ·è¡Œå¤±æ•—ã€æª”æ¡ˆç³»çµ±éŒ¯èª¤ï¼‰
- âŒ æ²’æœ‰éŒ¯èª¤ç¢¼çš„**å„ªå…ˆç´š**ï¼ˆå“ªäº›éœ€è¦ç«‹å³é€šçŸ¥ï¼Ÿå“ªäº›å¯ä»¥è‡ªå‹•é‡è©¦ï¼Ÿï¼‰
- âŒ æ²’æœ‰**éŒ¯èª¤æ¢å¾©æŒ‡å—**ï¼ˆé‡åˆ° `GEMINI_API_ERROR` è©²æ€éº¼è¾¦ï¼Ÿï¼‰

---

### å•é¡Œ 6ï¼šç¼ºå°‘éŒ¯èª¤è³‡è¨Šè¨˜éŒ„æ¬„ä½ï¼ˆé«˜é¢¨éšªï¼‰

**å•é¡Œä½ç½®ï¼š** `tech-specs/backend/database.md` (Project è³‡æ–™è¡¨)

**ç¾æœ‰è¨­è¨ˆï¼š**
Project è³‡æ–™è¡¨æ²’æœ‰è¨˜éŒ„è©³ç´°éŒ¯èª¤è³‡è¨Šçš„æ¬„ä½

**å•é¡Œé»ï¼š**
- âŒ å‰ç«¯ç„¡æ³•é¡¯ç¤ºã€Œç‚ºä»€éº¼å¤±æ•—ã€å’Œã€Œå¦‚ä½•è§£æ±ºã€
- âŒ ç”¨æˆ¶åªçŸ¥é“ã€Œå¤±æ•—äº†ã€ä½†ä¸çŸ¥é“åŸå› 
- âŒ ç„¡æ³•è¿½è¹¤éŒ¯èª¤æ­·å²

---

## å½±éŸ¿è©•ä¼°

### å½±éŸ¿ç¯„åœ
- **åŠŸèƒ½ï¼š** æ‰€æœ‰ API å‘¼å«ã€éŒ¯èª¤è™•ç†ã€æ—¥èªŒè¨˜éŒ„ã€å‰ç«¯éŒ¯èª¤é¡¯ç¤º
- **ç”¨æˆ¶ï¼š** æ‰€æœ‰ç”¨æˆ¶ï¼ˆé–‹ç™¼éšæ®µå¯èƒ½çœ‹ä¸å‡ºä¾†ï¼Œä½†ä¸Šç·šå¾Œæœƒåš´é‡å½±éŸ¿èª¿è©¦æ•ˆç‡ï¼‰
- **é »ç‡ï¼š** æ¯æ¬¡éŒ¯èª¤ç™¼ç”Ÿæ™‚éƒ½æœƒé‡åˆ°

### åš´é‡ç¨‹åº¦
- [x] è¨­è¨ˆç¼ºé™·ï¼ˆæœƒå½±éŸ¿æ•´å€‹ç³»çµ±çš„å¯ç¶­è­·æ€§å’Œèª¿è©¦èƒ½åŠ›ï¼‰
- [x] å½±éŸ¿é–‹ç™¼æ•ˆç‡ï¼ˆé›£ä»¥å®šä½å•é¡Œï¼‰
- [x] å½±éŸ¿ç”¨æˆ¶é«”é©—ï¼ˆéŒ¯èª¤è³‡è¨Šä¸æ˜ç¢ºï¼‰

### æ˜¯å¦æœ‰æ›¿ä»£æ–¹æ¡ˆ
- [ ] ç„¡æ›¿ä»£æ–¹æ¡ˆï¼ˆå¿…é ˆä¿®æ­£è¨­è¨ˆï¼‰

---

## æ ¹å› åˆ†æ

### æ ¹æœ¬åŸå› 
**åŸå› åˆ†é¡ï¼š**
- [x] Spec å®šç¾©ä¸æ¸…æ¥š
- [x] è¨­è¨ˆç¼ºé™·ï¼ˆéæ–¼æ¨‚è§€åœ°å‡è¨­éŒ¯èª¤å¯ä»¥è‡ªå‹•æ¢å¾©ï¼‰
- [x] ç¼ºå°‘çµ±ä¸€çš„éŒ¯èª¤è™•ç†ç­–ç•¥

### ç‚ºä»€éº¼æœƒæœ‰é€™äº›å•é¡Œ

1. **è¨­è¨ˆæ€ç¶­éæ–¼æ¨‚è§€**ï¼šå‡è¨­æ‰€æœ‰éŒ¯èª¤éƒ½å¯ä»¥é€šé fallback è§£æ±ºï¼Œå¿½ç•¥äº†èª¿è©¦å’Œç¶­è­·çš„éœ€æ±‚
2. **ç¼ºå°‘ã€Œå¤±æ•—é›¶å®¹å¿ã€çš„è¨­è¨ˆç†å¿µ**ï¼šæ²’æœ‰å¼·åˆ¶è¦æ±‚æ˜ç¢ºè™•ç†æ¯ç¨®éŒ¯èª¤æƒ…å¢ƒ
3. **æ—¥èªŒè¨­è¨ˆä¸è¶³**ï¼šæ²’æœ‰è€ƒæ…®åˆ°å¤šå°ˆæ¡ˆä¸¦è¡Œã€éŒ¯èª¤è¿½è¹¤ã€å¿«é€Ÿå®šä½çš„éœ€æ±‚
4. **å‰å¾Œç«¯è¨­è¨ˆåˆ†é›¢**ï¼šå‰å¾Œç«¯çš„éŒ¯èª¤è™•ç†ç­–ç•¥æ²’æœ‰çµ±ä¸€è¦åŠƒ

---

## è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå…¨é¢é‡æ§‹éŒ¯èª¤è™•ç†èˆ‡ Fallback ç­–ç•¥ï¼ˆå»ºè­°æ–¹æ¡ˆï¼‰

#### æ¦‚è¿°
å–æ¶ˆè‡ªå‹• fallbackï¼Œæ”¹ç‚ºæ˜ç¢ºå¤±æ•— + è¨˜éŒ„è©³ç´°éŒ¯èª¤è³‡è¨Š + å‰ç«¯é¡¯ç¤ºæ¢å¾©é¸é …ã€‚åŠ å…¥çµæ§‹åŒ–æ—¥èªŒã€Trace IDã€å®Œæ•´éŒ¯èª¤ç¢¼é«”ç³»ã€éŒ¯èª¤æ¢å¾©æŒ‡å—ã€‚

#### è©³ç´°ä¿®æ”¹æ¸…å–®

##### ä¿®æ”¹ 1ï¼šè™›æ“¬ä¸»æ’­ç”Ÿæˆæ”¹ç‚ºåš´æ ¼æ¨¡å¼

**æª”æ¡ˆï¼š** `tech-specs/backend/business-logic.md` å’Œ `tech-specs/backend/integrations.md`

**ä¿®æ”¹å…§å®¹ï¼š**

1. **å®šç¾©æ˜ç¢ºçš„éŒ¯èª¤é¡å‹**
```python
class AvatarGenerationError(Exception):
    """è™›æ“¬ä¸»æ’­ç”Ÿæˆå¤±æ•—"""
    def __init__(self, reason: str, is_retryable: bool, details: dict):
        self.reason = reason
        self.is_retryable = is_retryable
        self.details = details
```

2. **æ”¹ç‚ºåš´æ ¼å¤±æ•—æ¨¡å¼**
```python
def generate_avatar_strict(audio_url, avatar_image_url):
    """
    åš´æ ¼æ¨¡å¼ï¼šå¤±æ•—æ™‚æ‹‹å‡ºç•°å¸¸ï¼Œç”±å‘¼å«è€…æ±ºå®šå¦‚ä½•è™•ç†
    """
    try:
        return generate_avatar_video(audio_url, avatar_image_url)
    except DIDQuotaExceededError as e:
        # é…é¡ç”¨ç›¡ï¼šä¸å¯é‡è©¦
        raise AvatarGenerationError(
            reason="DID_QUOTA_EXCEEDED",
            is_retryable=False,
            details={
                "quota_used": e.quota_used,
                "quota_total": e.quota_total,
                "reset_date": e.reset_date
            }
        )
    except DIDAPIError as e:
        # API éŒ¯èª¤ï¼šå¯é‡è©¦
        raise AvatarGenerationError(
            reason="DID_API_ERROR",
            is_retryable=True,
            details={"status_code": e.status_code, "message": e.message}
        )
    except NetworkError as e:
        # ç¶²è·¯éŒ¯èª¤ï¼šå¯é‡è©¦
        raise AvatarGenerationError(
            reason="NETWORK_ERROR",
            is_retryable=True,
            details={"error": str(e)}
        )
```

3. **å‘¼å«è€…æ˜ç¢ºè™•ç†éŒ¯èª¤**
```python
try:
    avatar_video = generate_avatar_strict(audio_url, avatar_image_url)
except AvatarGenerationError as e:
    # è¨˜éŒ„è©³ç´°éŒ¯èª¤
    logger.error("Avatar generation failed", extra={
        "reason": e.reason,
        "is_retryable": e.is_retryable,
        "details": e.details,
        "project_id": project_id,
        "trace_id": trace_id
    })

    # æ›´æ–°å°ˆæ¡ˆç‹€æ…‹ç‚º FAILEDï¼Œä¸¦è¨˜éŒ„éŒ¯èª¤åŸå› 
    project.status = ProjectStatus.FAILED
    project.error_info = {
        "stage": "avatar_generation",
        "reason": e.reason,
        "details": e.details,
        "timestamp": datetime.utcnow().isoformat()
    }
    db.commit()

    # é€é WebSocket é€šçŸ¥å‰ç«¯
    await websocket_manager.send_error(
        project_id=project_id,
        error_code=e.reason,
        message="è™›æ“¬ä¸»æ’­ç”Ÿæˆå¤±æ•—",
        is_retryable=e.is_retryable,
        details=e.details
    )

    # æ‹‹å‡ºï¼Œè®“æ•´å€‹ä»»å‹™å¤±æ•—
    raise
```

##### ä¿®æ”¹ 2ï¼šåŠ å…¥çµæ§‹åŒ–æ—¥èªŒ + Trace ID

**æ–°å¢æª”æ¡ˆï¼š** `tech-specs/backend/logging.md`

**å…§å®¹ï¼š**
```markdown
# æ—¥èªŒè¦ç¯„

## 1. çµæ§‹åŒ–æ—¥èªŒ

æ‰€æœ‰æ—¥èªŒå¿…é ˆä½¿ç”¨ JSON æ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š

- `trace_id`: è¿½è¹¤ IDï¼ˆæ¯å€‹è«‹æ±‚å”¯ä¸€ï¼‰
- `timestamp`: æ™‚é–“æˆ³è¨˜ï¼ˆISO 8601 æ ¼å¼ï¼‰
- `level`: æ—¥èªŒç­‰ç´šï¼ˆinfo, warning, errorï¼‰
- `message`: æ—¥èªŒè¨Šæ¯
- `project_id`: å°ˆæ¡ˆ IDï¼ˆå¦‚æœç›¸é—œï¼‰
- `api`: API åç¨±ï¼ˆå¦‚æœç›¸é—œï¼‰
- `duration_ms`: åŸ·è¡Œæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
- `error_code`: éŒ¯èª¤ç¢¼ï¼ˆå¦‚æœæ˜¯éŒ¯èª¤ï¼‰
- `details`: é¡å¤–è³‡è¨Šï¼ˆdictï¼‰

## 2. StructuredLogger å¯¦ä½œ

```python
import logging
import uuid
import json
from contextvars import ContextVar
from datetime import datetime

# æ¯å€‹è«‹æ±‚éƒ½æœ‰å”¯ä¸€çš„ trace_id
trace_id_var: ContextVar[str] = ContextVar('trace_id', default='')

class StructuredLogger:
    """çµæ§‹åŒ–æ—¥èªŒè¨˜éŒ„å™¨"""

    def __init__(self, name: str):
        self.logger = logging.getLogger(name)

    def log(self, level: str, message: str, **extra):
        """è¨˜éŒ„çµæ§‹åŒ–æ—¥èªŒ"""
        trace_id = trace_id_var.get()
        log_data = {
            "trace_id": trace_id,
            "timestamp": datetime.utcnow().isoformat() + "Z",
            "message": message,
            **extra
        }

        # è¼¸å‡º JSON æ ¼å¼
        self.logger.log(
            getattr(logging, level.upper()),
            json.dumps(log_data, ensure_ascii=False)
        )

    def error(self, message: str, **extra):
        self.log("error", message, **extra)

    def info(self, message: str, **extra):
        self.log("info", message, **extra)

    def warning(self, message: str, **extra):
        self.log("warning", message, **extra)
```

## 3. ä½¿ç”¨ç¯„ä¾‹

```python
logger = StructuredLogger(__name__)

# API è«‹æ±‚é–‹å§‹
trace_id = str(uuid.uuid4())
trace_id_var.set(trace_id)

logger.info("API request started", extra={
    "endpoint": "/api/v1/projects",
    "method": "POST",
    "project_id": project_id
})

# API å‘¼å« Gemini
logger.info("Calling Gemini API", extra={
    "api": "gemini",
    "model": "gemini-1.5-flash",
    "prompt_length": len(prompt),
    "project_id": project_id
})

# éŒ¯èª¤ç™¼ç”Ÿ
logger.error("Gemini API failed", extra={
    "api": "gemini",
    "error_code": "QUOTA_EXCEEDED",
    "status_code": 429,
    "project_id": project_id,
    "retry_attempt": 2
})
```
```

**ä¿®æ”¹æª”æ¡ˆï¼š** `tech-specs/backend/overview.md:248-253`

æ›¿æ›ç‚ºï¼šåƒè€ƒ `logging.md` è¦ç¯„

##### ä¿®æ”¹ 3ï¼šå®Œå–„éŒ¯èª¤ç¢¼é«”ç³»

**æ–°å¢æª”æ¡ˆï¼š** `tech-specs/backend/error-codes.md`

**å…§å®¹ï¼š**
```markdown
# éŒ¯èª¤ç¢¼é«”ç³»

## 1. Gemini API éŒ¯èª¤

| éŒ¯èª¤ç¢¼ | èªªæ˜ | HTTP Status | å¯é‡è©¦ | æ¢å¾©æŒ‡å— |
|--------|------|-------------|--------|----------|
| GEMINI_QUOTA_EXCEEDED | Gemini é…é¡ç”¨ç›¡ | 429 | âŒ | ç­‰å¾…é…é¡é‡ç½®æˆ–å‡ç´šæ–¹æ¡ˆ |
| GEMINI_INVALID_API_KEY | API Key ç„¡æ•ˆ | 401 | âŒ | æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢º |
| GEMINI_RATE_LIMIT | è«‹æ±‚éæ–¼é »ç¹ | 429 | âœ… | ç­‰å¾… 10 ç§’å¾Œé‡è©¦ |
| GEMINI_SERVER_ERROR | Gemini ä¼ºæœå™¨éŒ¯èª¤ | 500 | âœ… | ç­‰å¾… 5 ç§’å¾Œé‡è©¦ |
| GEMINI_CONTENT_POLICY | å…§å®¹é•åæ”¿ç­– | 400 | âŒ | ä¿®æ”¹ Prompt å…§å®¹ |
| GEMINI_TIMEOUT | è«‹æ±‚è¶…æ™‚ | 504 | âœ… | é‡è©¦ä¸€æ¬¡ |
| GEMINI_NETWORK_ERROR | ç¶²è·¯é€£ç·šå¤±æ•— | 503 | âœ… | æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦ |

## 2. Stability AI éŒ¯èª¤

| éŒ¯èª¤ç¢¼ | èªªæ˜ | HTTP Status | å¯é‡è©¦ | æ¢å¾©æŒ‡å— |
|--------|------|-------------|--------|----------|
| STABILITY_QUOTA_EXCEEDED | åœ–ç‰‡ç”Ÿæˆé…é¡ç”¨ç›¡ | 429 | âŒ | ç­‰å¾…é…é¡é‡ç½®æˆ–è³¼è²·é¡åº¦ |
| STABILITY_INVALID_PROMPT | Prompt ä¸åˆæ³• | 400 | âŒ | ä¿®æ”¹åœ–ç‰‡æè¿° |
| STABILITY_RATE_LIMIT | è«‹æ±‚éæ–¼é »ç¹ | 429 | âœ… | æŒ‡æ•¸é€€é¿é‡è©¦ |
| STABILITY_CONTENT_POLICY | é•åå…§å®¹æ”¿ç­– | 400 | âŒ | ä¿®æ”¹åœ–ç‰‡æè¿°ï¼Œç§»é™¤æ•æ„Ÿå…§å®¹ |
| STABILITY_SERVER_ERROR | Stability AI ä¼ºæœå™¨éŒ¯èª¤ | 500 | âœ… | ç­‰å¾… 5 ç§’å¾Œé‡è©¦ |
| STABILITY_TIMEOUT | åœ–ç‰‡ç”Ÿæˆè¶…æ™‚ | 504 | âœ… | é‡è©¦ä¸€æ¬¡ |

## 3. D-ID éŒ¯èª¤

| éŒ¯èª¤ç¢¼ | èªªæ˜ | HTTP Status | å¯é‡è©¦ | æ¢å¾©æŒ‡å— |
|--------|------|-------------|--------|----------|
| DID_QUOTA_EXCEEDED | è™›æ“¬ä¸»æ’­é…é¡ç”¨ç›¡ | 429 | âŒ | ç­‰å¾…é…é¡é‡ç½®ï¼ˆæœˆåº¦ï¼‰æˆ–å‡ç´šæ–¹æ¡ˆ |
| DID_INVALID_API_KEY | API Key ç„¡æ•ˆ | 401 | âŒ | æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢º |
| DID_PROCESSING_TIMEOUT | è™•ç†è¶…æ™‚ | 504 | âœ… | é‡è©¦ä¸€æ¬¡ |
| DID_INVALID_AUDIO | éŸ³è¨Šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º | 400 | âŒ | æª¢æŸ¥éŸ³è¨Šæª”æ¡ˆæ ¼å¼å’Œå¤§å° |
| DID_SERVER_ERROR | D-ID ä¼ºæœå™¨éŒ¯èª¤ | 500 | âœ… | ç­‰å¾… 30 ç§’å¾Œé‡è©¦ |

## 4. YouTube API éŒ¯èª¤

| éŒ¯èª¤ç¢¼ | èªªæ˜ | HTTP Status | å¯é‡è©¦ | æ¢å¾©æŒ‡å— |
|--------|------|-------------|--------|----------|
| YOUTUBE_QUOTA_EXCEEDED | YouTube é…é¡ç”¨ç›¡ | 403 | âŒ | ç­‰å¾…é…é¡é‡ç½®ï¼ˆæ¯æ—¥ï¼‰æˆ–ç”³è«‹å¢åŠ é…é¡ |
| YOUTUBE_INVALID_TOKEN | OAuth Token ç„¡æ•ˆ | 401 | âœ… | ä½¿ç”¨ Refresh Token æ›´æ–° |
| YOUTUBE_TOKEN_EXPIRED | OAuth Token éæœŸ | 401 | âœ… | ä½¿ç”¨ Refresh Token æ›´æ–° |
| YOUTUBE_UPLOAD_FAILED | å½±ç‰‡ä¸Šå‚³å¤±æ•— | 500 | âœ… | ä½¿ç”¨ Resumable Upload é‡è©¦ |
| YOUTUBE_VIDEO_TOO_LARGE | å½±ç‰‡æª”æ¡ˆéå¤§ | 400 | âŒ | å£“ç¸®å½±ç‰‡æˆ–åˆ†æ®µä¸Šå‚³ |

## 5. ç³»çµ±éŒ¯èª¤

| éŒ¯èª¤ç¢¼ | èªªæ˜ | HTTP Status | å¯é‡è©¦ | æ¢å¾©æŒ‡å— |
|--------|------|-------------|--------|----------|
| FFMPEG_EXECUTION_FAILED | FFmpeg åŸ·è¡Œå¤±æ•— | 500 | âŒ | æª¢æŸ¥ FFmpeg å®‰è£ã€æª”æ¡ˆæ¬Šé™ã€ç£ç¢Ÿç©ºé–“ |
| FFMPEG_NOT_FOUND | FFmpeg æœªå®‰è£ | 500 | âŒ | å®‰è£ FFmpeg |
| REDIS_CONNECTION_FAILED | Redis é€£ç·šå¤±æ•— | 500 | âœ… | æª¢æŸ¥ Redis æœå‹™æ˜¯å¦é‹è¡Œ |
| DATABASE_ERROR | è³‡æ–™åº«éŒ¯èª¤ | 500 | âœ… | æª¢æŸ¥è³‡æ–™åº«é€£ç·š |
| FILE_SYSTEM_ERROR | æª”æ¡ˆç³»çµ±éŒ¯èª¤ | 500 | âŒ | æª¢æŸ¥ç£ç¢Ÿç©ºé–“ã€æ¬Šé™ |
| DISK_SPACE_INSUFFICIENT | ç£ç¢Ÿç©ºé–“ä¸è¶³ | 500 | âŒ | æ¸…ç†ç£ç¢Ÿç©ºé–“ |
| FILE_NOT_FOUND | æª”æ¡ˆä¸å­˜åœ¨ | 404 | âŒ | ç¢ºèªæª”æ¡ˆè·¯å¾‘æ­£ç¢º |
| CELERY_TASK_FAILED | Celery ä»»å‹™å¤±æ•— | 500 | âœ… | æª¢æŸ¥ Celery Worker ç‹€æ…‹ |
| VALIDATION_ERROR | è¼¸å…¥é©—è­‰éŒ¯èª¤ | 400 | âŒ | æª¢æŸ¥è¼¸å…¥åƒæ•¸ |

## 6. éŒ¯èª¤å„ªå…ˆç´š

### P0 - ç«‹å³é€šçŸ¥
- API Key ç„¡æ•ˆï¼ˆæ‰€æœ‰æœå‹™ï¼‰
- é…é¡å³å°‡ç”¨ç›¡ (< 10%)
- è³‡æ–™åº«é€£ç·šå¤±æ•—
- Redis é€£ç·šå¤±æ•—
- FFmpeg æœªå®‰è£

### P1 - é‡è¦é€šçŸ¥
- é€£çºŒå¤±æ•— > 5 æ¬¡
- é…é¡ç”¨ç›¡
- æª”æ¡ˆç³»çµ±éŒ¯èª¤
- ç£ç¢Ÿç©ºé–“ä¸è¶³

### P2 - ä¸€èˆ¬è¨˜éŒ„
- å–®æ¬¡ API å‘¼å«å¤±æ•—ï¼ˆä½†æœƒé‡è©¦ï¼‰
- ç¶²è·¯æš«æ™‚æ€§éŒ¯èª¤
- Rate Limit è§¸ç™¼
```

##### ä¿®æ”¹ 4ï¼šProject è³‡æ–™è¡¨åŠ å…¥ error_info æ¬„ä½

**ä¿®æ”¹æª”æ¡ˆï¼š** `tech-specs/backend/database.md`

**åœ¨ Project è³‡æ–™è¡¨å®šç¾©ä¸­åŠ å…¥ï¼š**

```sql
error_info JSON NULL DEFAULT NULL
```

**æ¬„ä½èªªæ˜ï¼š**
```json
{
  "stage": "assets_generating",  # å“ªå€‹éšæ®µå¤±æ•—
  "error_code": "GEMINI_QUOTA_EXCEEDED",  # éŒ¯èª¤ç¢¼
  "error_message": "Gemini API quota exceeded",  # éŒ¯èª¤è¨Šæ¯
  "is_retryable": false,  # æ˜¯å¦å¯é‡è©¦
  "details": {
    "api": "gemini",
    "quota_used": 1000,
    "quota_total": 1000
  },
  "timestamp": "2025-10-20T10:30:00Z",  # éŒ¯èª¤ç™¼ç”Ÿæ™‚é–“
  "trace_id": "abc-123-def-456"  # è¿½è¹¤ ID
}
```

##### ä¿®æ”¹ 5ï¼šå‰ç«¯çµ±ä¸€éŒ¯èª¤è™•ç†

**ä¿®æ”¹æª”æ¡ˆï¼š** `tech-specs/frontend/api-integration.md`

**åŠ å…¥ç« ç¯€ï¼šã€ŒéŒ¯èª¤è™•ç†çµ±ä¸€è¦ç¯„ã€**

```typescript
// å‰ç«¯éŒ¯èª¤è™•ç†
websocket.on('error', (error) => {
  // é¡¯ç¤ºè©³ç´°éŒ¯èª¤
  toast.error(`ç”Ÿæˆå¤±æ•—ï¼š${error.message}`)

  // è¨˜éŒ„åˆ°æ—¥èªŒï¼ˆä½¿ç”¨ç›¸åŒçš„ trace_idï¼‰
  logger.error("Generation failed", {
    trace_id: error.trace_id,
    error_code: error.error_code,
    details: error.details,
    project_id: projectId
  })

  // å¦‚æœå¯é‡è©¦ï¼Œé¡¯ç¤ºé‡è©¦æŒ‰éˆ•
  if (error.is_retryable) {
    showRetryButton(projectId)
  } else {
    // ä¸å¯é‡è©¦ï¼Œé¡¯ç¤ºåŸå› å’Œè§£æ±ºæ–¹æ¡ˆ
    showErrorDialog({
      title: 'ç”Ÿæˆå¤±æ•—',
      reason: error.error_code,
      details: error.details,
      solutions: getErrorSolutions(error.error_code)
    })
  }
})

// éŒ¯èª¤è§£æ±ºæ–¹æ¡ˆå°ç…§è¡¨
function getErrorSolutions(error_code: string): string[] {
  const solutions = {
    'GEMINI_QUOTA_EXCEEDED': [
      'ç­‰å¾…é…é¡é‡ç½®ï¼ˆæ¯æ—¥ï¼‰',
      'å‡ç´š Gemini API æ–¹æ¡ˆ',
      'è¯çµ¡ç®¡ç†å“¡å¢åŠ é…é¡'
    ],
    'DID_QUOTA_EXCEEDED': [
      'ç­‰å¾…é…é¡é‡ç½®ï¼ˆæ¯æœˆ 1 è™Ÿï¼‰',
      'å‡ç´š D-ID æ–¹æ¡ˆ',
      'æš«æ™‚ä¸ä½¿ç”¨è™›æ“¬ä¸»æ’­åŠŸèƒ½'
    ],
    'STABILITY_INVALID_PROMPT': [
      'ä¿®æ”¹åœ–ç‰‡æè¿°ï¼Œç§»é™¤æ•æ„Ÿè©å½™',
      'ä½¿ç”¨æ›´é€šç”¨çš„æè¿°',
      'åƒè€ƒç¯„ä¾‹ Prompt'
    ],
    // ... å…¶ä»–éŒ¯èª¤ç¢¼
  }
  return solutions[error_code] || ['è¯çµ¡æŠ€è¡“æ”¯æ´']
}
```

##### ä¿®æ”¹ 6ï¼šæ–°å¢éŒ¯èª¤ç›£æ§è¦ç¯„

**æ–°å¢æª”æ¡ˆï¼š** `tech-specs/backend/monitoring.md`

**å…§å®¹ï¼š**
```markdown
# éŒ¯èª¤ç›£æ§èˆ‡è­¦å ±

## 1. é—œéµéŒ¯èª¤éœ€ç«‹å³é€šçŸ¥

ä»¥ä¸‹éŒ¯èª¤ç™¼ç”Ÿæ™‚ï¼Œæ‡‰ç«‹å³é€šçŸ¥é–‹ç™¼è€…ï¼ˆé€éæ—¥èªŒè­¦å ±æˆ– webhookï¼‰ï¼š

- **API Key ç„¡æ•ˆ** â†’ å¯èƒ½æ˜¯ Key è¢«æ’¤éŠ·æˆ–éæœŸ
- **é…é¡å³å°‡ç”¨ç›¡** (< 10%) â†’ é¿å…å½±éŸ¿æ­£å¸¸ä½¿ç”¨
- **é€£çºŒå¤±æ•— > 5 æ¬¡** â†’ å¯èƒ½æ˜¯ç³»çµ±æ€§å•é¡Œ
- **è³‡æ–™åº«é€£ç·šå¤±æ•—** â†’ åš´é‡çš„åŸºç¤è¨­æ–½å•é¡Œ
- **FFmpeg åŸ·è¡Œå¤±æ•—** â†’ å½±éŸ¿æ‰€æœ‰å½±ç‰‡ç”Ÿæˆ
- **Redis é€£ç·šå¤±æ•—** â†’ å½±éŸ¿å¿«å–å’Œä»»å‹™ä½‡åˆ—

## 2. ç›£æ§æŒ‡æ¨™

### API å‘¼å«ç›£æ§
- **æˆåŠŸç‡**ï¼šæ¯å€‹ API çš„æˆåŠŸç‡ï¼ˆç›®æ¨™ > 95%ï¼‰
- **å›æ‡‰æ™‚é–“**ï¼šP50, P90, P99 å»¶é²
- **éŒ¯èª¤ç‡**ï¼šæ¯ç¨®éŒ¯èª¤ç¢¼çš„ç™¼ç”Ÿé »ç‡
- **é‡è©¦æ¬¡æ•¸**ï¼šå¹³å‡é‡è©¦æ¬¡æ•¸

### ç³»çµ±ç›£æ§
- **ç£ç¢Ÿç©ºé–“**ï¼šå‰©é¤˜ç©ºé–“ï¼ˆè­¦å‘Š < 20%ï¼Œåš´é‡ < 10%ï¼‰
- **CPU ä½¿ç”¨ç‡**ï¼šå¹³å‡ CPU ä½¿ç”¨ç‡
- **è¨˜æ†¶é«”ä½¿ç”¨ç‡**ï¼šå¹³å‡è¨˜æ†¶é«”ä½¿ç”¨ç‡
- **Celery ä½‡åˆ—é•·åº¦**ï¼šå¾…è™•ç†ä»»å‹™æ•¸é‡

### é…é¡ç›£æ§
- **D-ID é…é¡**ï¼šæ¯æ—¥åŒæ­¥ï¼Œè­¦å‘Š < 20%
- **YouTube é…é¡**ï¼šæ¯å°æ™‚åŒæ­¥ï¼Œè­¦å‘Š < 20%
- **Gemini é…é¡**ï¼šæ¯æ—¥åŒæ­¥ï¼Œè­¦å‘Š < 20%
- **Stability AI é…é¡**ï¼šæ¯æ—¥åŒæ­¥ï¼Œè­¦å‘Š < 20%

## 3. ç›£æ§å·¥å…·ï¼ˆå¯é¸ï¼‰

### é–‹ç™¼éšæ®µ
- **æœ¬åœ°æ—¥èªŒ**ï¼šçµæ§‹åŒ– JSON æ—¥èªŒ
- **pytest-cov**ï¼šç¢ºä¿éŒ¯èª¤è™•ç†è·¯å¾‘æœ‰æ¸¬è©¦è¦†è“‹

### ç”Ÿç”¢éšæ®µï¼ˆæœªä¾†å¯æ“´å±•ï¼‰
- **Sentry**ï¼šè‡ªå‹•æ•ç²å’ŒèšåˆéŒ¯èª¤
- **Prometheus + Grafana**ï¼šç›£æ§ API å‘¼å«æ¬¡æ•¸ã€æˆåŠŸç‡ã€å»¶é²
- **ELK Stack**ï¼šé›†ä¸­åŒ–æ—¥èªŒåˆ†æ

## 4. è­¦å ±è¦å‰‡

### ç«‹å³é€šçŸ¥ï¼ˆP0ï¼‰
- API Key ç„¡æ•ˆ
- è³‡æ–™åº«/Redis é€£ç·šå¤±æ•—
- ç£ç¢Ÿç©ºé–“ < 10%
- FFmpeg åŸ·è¡Œå¤±æ•—

### 1 å°æ™‚å…§é€šçŸ¥ï¼ˆP1ï¼‰
- é…é¡ < 10%
- é€£çºŒå¤±æ•— > 5 æ¬¡
- éŒ¯èª¤ç‡ > 10%

### æ¯æ—¥å½™ç¸½ï¼ˆP2ï¼‰
- é…é¡ä½¿ç”¨é‡
- API æˆåŠŸç‡çµ±è¨ˆ
- å¸¸è¦‹éŒ¯èª¤çµ±è¨ˆ
```

#### éœ€è¦æ›´æ–°çš„ Spec æª”æ¡ˆæ¸…å–®

- [x] `tech-specs/backend/business-logic.md` - ç§»é™¤è‡ªå‹• fallback
- [x] `tech-specs/backend/integrations.md` - ç§»é™¤è‡ªå‹• fallback
- [x] `tech-specs/backend/overview.md` - æ›´æ–°æ—¥èªŒè¦ç¯„ï¼ˆæ”¹ç‚ºå¼•ç”¨ logging.mdï¼‰
- [x] **æ–°å¢** `tech-specs/backend/logging.md` - çµæ§‹åŒ–æ—¥èªŒè¦ç¯„
- [x] **æ–°å¢** `tech-specs/backend/error-codes.md` - å®Œæ•´éŒ¯èª¤ç¢¼é«”ç³»
- [x] **æ–°å¢** `tech-specs/backend/monitoring.md` - éŒ¯èª¤ç›£æ§è¦ç¯„
- [x] `tech-specs/backend/database.md` - Project è³‡æ–™è¡¨åŠ å…¥ error_info æ¬„ä½
- [x] `tech-specs/frontend/api-integration.md` - çµ±ä¸€éŒ¯èª¤è™•ç†ç­–ç•¥

#### å„ªé»
- âœ… **å¤±æ•—é›¶å®¹å¿**ï¼šæ‰€æœ‰éŒ¯èª¤éƒ½æœƒæ˜ç¢ºè¨˜éŒ„å’Œé€šçŸ¥
- âœ… **è¼•é¬†å®šä½éŒ¯èª¤**ï¼šTrace ID + çµæ§‹åŒ–æ—¥èªŒ + è©³ç´°éŒ¯èª¤è³‡è¨Š
- âœ… **ç”¨æˆ¶é«”é©—å¥½**ï¼šæ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯å’Œè§£æ±ºæ–¹æ¡ˆ
- âœ… **å¯ç¶­è­·æ€§é«˜**ï¼šçµ±ä¸€çš„éŒ¯èª¤è™•ç†ç­–ç•¥
- âœ… **å¯æ“´å±•æ€§å¥½**ï¼šå®Œæ•´çš„éŒ¯èª¤ç¢¼é«”ç³»æ–¹ä¾¿æœªä¾†æ“´å±•

#### ç¼ºé»
- å¯¦ä½œè¤‡é›œåº¦è¼ƒé«˜ï¼ˆéœ€è¦æ”¹å‹•å¤šå€‹æ¨¡çµ„ï¼‰
- éœ€è¦å‰å¾Œç«¯å”åŒä¿®æ”¹
- é–‹ç™¼æ™‚é–“è¼ƒé•·

#### é¢¨éšªè©•ä¼°
- **é¢¨éšª**ï¼šä¿®æ”¹ç¯„åœè¼ƒå¤§ï¼Œå¯èƒ½å½±éŸ¿åŸå®šé–‹ç™¼è¨ˆåŠƒ
- **ç·©è§£**ï¼šåœ¨é–‹ç™¼å‰å°±ç™¼ç¾å•é¡Œï¼Œä¿®æ”¹ spec å¾Œå†é–‹ç™¼ï¼Œé¿å…è¿”å·¥

---

### æ–¹æ¡ˆ 2ï¼šä¿æŒéƒ¨åˆ† Fallbackï¼ŒåŠ å¼·æ—¥èªŒ

**ä¸å»ºè­°æ¡ç”¨**ï¼Œå› ç‚ºç„¡æ³•æ ¹æœ¬è§£æ±ºã€Œå¤±æ•—é›¶å®¹å¿ã€çš„éœ€æ±‚ã€‚

---

### æ–¹æ¡ˆæ¯”è¼ƒ

| é …ç›® | æ–¹æ¡ˆ 1ï¼ˆå»ºè­°ï¼‰ | æ–¹æ¡ˆ 2ï¼ˆä¸å»ºè­°ï¼‰ |
|-----|--------------|----------------|
| å¯¦ä½œè¤‡é›œåº¦ | ä¸­ | ä½ |
| ä¿®æ”¹ç¯„åœ | å¤§ï¼ˆ8 å€‹æª”æ¡ˆï¼‰ | å°ï¼ˆ2 å€‹æª”æ¡ˆï¼‰ |
| å¤±æ•—é›¶å®¹å¿ | âœ… å®Œå…¨ç¬¦åˆ | âŒ ç„¡æ³•æ»¿è¶³ |
| è¼•é¬†å®šä½éŒ¯èª¤ | âœ… å®Œå…¨ç¬¦åˆ | ğŸŸ¡ éƒ¨åˆ†ç¬¦åˆ |
| ç¶­è­·æ€§ | âœ… é«˜ | ğŸŸ¡ ä¸­ |
| é¢¨éšª | ä½ | ä¸­ï¼ˆæœªä¾†é‚„æ˜¯è¦æ”¹ï¼‰ |

**å»ºè­°æ¡ç”¨ï¼š** æ–¹æ¡ˆ 1

**ç†ç”±ï¼š**
1. å®Œå…¨ç¬¦åˆã€Œå¤±æ•—é›¶å®¹å¿ã€å’Œã€Œè¼•é¬†å®šä½éŒ¯èª¤ã€çš„éœ€æ±‚
2. åœ¨é–‹ç™¼å‰å°±ä¿®æ”¹ specï¼Œé¿å…é–‹ç™¼å¾Œè¿”å·¥
3. å»ºç«‹çµ±ä¸€çš„éŒ¯èª¤è™•ç†è¦ç¯„ï¼Œå°æœªä¾†ç¶­è­·æœ‰é•·é å¥½è™•
4. é›–ç„¶ä¿®æ”¹ç¯„åœè¼ƒå¤§ï¼Œä½†éƒ½æ˜¯æ–°å¢æˆ–æ˜ç¢ºåŒ–ç¾æœ‰è¨­è¨ˆï¼Œé¢¨éšªå¯æ§

---

## å¯¦ä½œè¨ˆåŠƒ

### ç¬¬ 1 æ­¥ï¼šæ›´æ–° Spec æ–‡ä»¶ï¼ˆé ä¼° 2 å°æ™‚ï¼‰

æŒ‰ç…§ã€Œéœ€è¦æ›´æ–°çš„ Spec æª”æ¡ˆæ¸…å–®ã€é€ä¸€ä¿®æ”¹ï¼š

1. æ–°å¢ `tech-specs/backend/logging.md`
2. æ–°å¢ `tech-specs/backend/error-codes.md`
3. æ–°å¢ `tech-specs/backend/monitoring.md`
4. ä¿®æ”¹ `tech-specs/backend/business-logic.md`
5. ä¿®æ”¹ `tech-specs/backend/integrations.md`
6. ä¿®æ”¹ `tech-specs/backend/overview.md`
7. ä¿®æ”¹ `tech-specs/backend/database.md`
8. ä¿®æ”¹ `tech-specs/frontend/api-integration.md`

### ç¬¬ 2 æ­¥ï¼šæ›´æ–° Task æ–‡ä»¶ï¼ˆé ä¼° 1 å°æ™‚ï¼‰

æª¢æŸ¥æ‰€æœ‰ Phase 1 task æ–‡ä»¶ï¼Œç¢ºä¿ï¼š
- æ¸¬è©¦è¦æ±‚åŒ…å«éŒ¯èª¤è™•ç†æ¸¬è©¦
- å¯¦ä½œè¦æ ¼éµå¾ªæ–°çš„éŒ¯èª¤è™•ç†ç­–ç•¥
- æ—¥èªŒè¨˜éŒ„ç¬¦åˆçµæ§‹åŒ–æ—¥èªŒè¦ç¯„

éœ€è¦æª¢æŸ¥çš„ taskï¼š
- Task-004: Projects APIï¼ˆéŒ¯èª¤è™•ç†ï¼‰
- Task-006: System APIï¼ˆAPI Key æ¸¬è©¦éŒ¯èª¤è™•ç†ï¼‰
- Task-014: Celery ä»»å‹™ï¼ˆä»»å‹™å¤±æ•—è™•ç†ï¼‰
- Task-015: Gemini æ•´åˆï¼ˆAPI éŒ¯èª¤è™•ç†ï¼‰
- Task-016: WebSocketï¼ˆéŒ¯èª¤è¨Šæ¯æ¨é€ï¼‰

### ç¬¬ 3 æ­¥ï¼šé©—è­‰ Spec å®Œæ•´æ€§ï¼ˆé ä¼° 30 åˆ†é˜ï¼‰

- [ ] æ‰€æœ‰éŒ¯èª¤æƒ…å¢ƒéƒ½æœ‰å°æ‡‰çš„éŒ¯èª¤ç¢¼
- [ ] æ‰€æœ‰éŒ¯èª¤ç¢¼éƒ½æœ‰æ¢å¾©æŒ‡å—
- [ ] å‰å¾Œç«¯éŒ¯èª¤è™•ç†ç­–ç•¥ä¸€è‡´
- [ ] æ—¥èªŒè¦ç¯„æ¸…æ¥šæ˜ç¢º
- [ ] è³‡æ–™åº« Schema åŒ…å« error_info æ¬„ä½

### ç¬¬ 4 æ­¥ï¼šCommit ä¸¦åˆä½µ

```bash
git add tech-specs/ issues/
git commit -m "fix: é‡æ§‹éŒ¯èª¤è™•ç†èˆ‡ fallback ç­–ç•¥ [issue-001]

- æ–°å¢çµæ§‹åŒ–æ—¥èªŒè¦ç¯„ï¼ˆlogging.mdï¼‰
- æ–°å¢å®Œæ•´éŒ¯èª¤ç¢¼é«”ç³»ï¼ˆerror-codes.mdï¼‰
- æ–°å¢éŒ¯èª¤ç›£æ§è¦ç¯„ï¼ˆmonitoring.mdï¼‰
- ç§»é™¤è™›æ“¬ä¸»æ’­è‡ªå‹• fallbackï¼Œæ”¹ç‚ºæ˜ç¢ºå¤±æ•—
- Project è³‡æ–™è¡¨åŠ å…¥ error_info æ¬„ä½
- çµ±ä¸€å‰å¾Œç«¯éŒ¯èª¤è™•ç†ç­–ç•¥

Closes #issue-001"

git push origin feature/update-phase1-plan
```

---

## é é˜²æªæ–½

### ç‚ºä»€éº¼æœƒç™¼ç”Ÿé€™å€‹å•é¡Œ
1. **è¨­è¨ˆéšæ®µæ²’æœ‰æ˜ç¢ºã€Œå¤±æ•—é›¶å®¹å¿ã€çš„éœ€æ±‚**ï¼šå‡è¨­éŒ¯èª¤å¯ä»¥è‡ªå‹•æ¢å¾©
2. **ç¼ºå°‘ Spec Review æµç¨‹**ï¼šå¦‚æœæ²’æœ‰åœ¨é–‹ç™¼å‰æª¢æŸ¥ï¼Œé€™äº›å•é¡Œæœƒåœ¨é–‹ç™¼å¾Œæ‰ç™¼ç¾
3. **æ—¥èªŒè¨­è¨ˆç¶“é©—ä¸è¶³**ï¼šæ²’æœ‰è€ƒæ…®åˆ°èª¿è©¦å’Œè¿½è¹¤çš„éœ€æ±‚

### å¦‚ä½•é¿å…é¡ä¼¼å•é¡Œ
1. **åœ¨æ‰€æœ‰ Spec ä¸­æ˜ç¢ºéŒ¯èª¤è™•ç†ç­–ç•¥**ï¼šæ¯å€‹ APIã€æ¯å€‹æœå‹™éƒ½è¦å®šç¾©éŒ¯èª¤è™•ç†æ–¹å¼
2. **å»ºç«‹ Spec Review Checklist**ï¼šåŒ…å«éŒ¯èª¤è™•ç†ã€æ—¥èªŒã€ç›£æ§ç­‰é …ç›®
3. **åƒè€ƒæ¥­ç•Œæœ€ä½³å¯¦è¸**ï¼šçµæ§‹åŒ–æ—¥èªŒã€Trace IDã€éŒ¯èª¤ç¢¼é«”ç³»éƒ½æ˜¯æˆç†Ÿçš„åšæ³•

### éœ€è¦æ”¹é€²çš„åœ°æ–¹
- **é–‹ç™¼æµç¨‹ï¼š** åŠ å…¥ Spec Review éšæ®µï¼ˆåœ¨é–‹ç™¼å‰ï¼‰
- **æ–‡ä»¶è¦ç¯„ï¼š** å»ºç«‹éŒ¯èª¤è™•ç†çš„çµ±ä¸€ç¯„æœ¬
- **è¨­è¨ˆåŸå‰‡ï¼š** æ˜ç¢ºã€Œå¤±æ•—é›¶å®¹å¿ã€ä½œç‚ºæ ¸å¿ƒè¨­è¨ˆç†å¿µ

---

## ç›¸é—œè³‡æº

### ç›¸é—œ Task
- Task-001: å°ˆæ¡ˆåˆå§‹åŒ–ï¼ˆéœ€è¦é…ç½®æ—¥èªŒï¼‰
- Task-004: Projects APIï¼ˆéœ€è¦éŒ¯èª¤è™•ç†ï¼‰
- Task-006: System APIï¼ˆéœ€è¦ API Key æ¸¬è©¦éŒ¯èª¤è™•ç†ï¼‰
- Task-014: Celery ä»»å‹™ï¼ˆéœ€è¦ä»»å‹™å¤±æ•—è™•ç†ï¼‰
- Task-015: Gemini æ•´åˆï¼ˆéœ€è¦ API éŒ¯èª¤è™•ç†ï¼‰
- Task-016: WebSocketï¼ˆéœ€è¦éŒ¯èª¤è¨Šæ¯æ¨é€ï¼‰

### åƒè€ƒè³‡æº
- [Structured Logging Best Practices](https://www.sumologic.com/blog/structured-logging-best-practices/)
- [HTTP Status Codes](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)
- [Error Handling in Microservices](https://microservices.io/patterns/reliability/error-handling.html)
- [Sentry Error Tracking](https://sentry.io/)

---

## æ™‚é–“è¨˜éŒ„

- **ç™¼ç¾æ™‚é–“ï¼š** 2025-10-20 14:00
- **é–‹å§‹è™•ç†ï¼š** 2025-10-20 14:30
- **é è¨ˆå®Œæˆï¼š** 2025-10-20 17:30
- **é ä¼°ç¸½è€—æ™‚ï¼š** 3.5 å°æ™‚

---

## æª¢æŸ¥æ¸…å–®

### å•é¡Œåˆ†æ
- [x] æ‰¾åˆ°æ‰€æœ‰ç›¸é—œçš„è¨­è¨ˆå•é¡Œ
- [x] è©•ä¼°å½±éŸ¿ç¯„åœ
- [x] ç¢ºèªéœ€è¦ä¿®æ”¹å“ªäº› spec

### è§£æ±ºæ–¹æ¡ˆ
- [x] æå‡ºå®Œæ•´çš„è§£æ±ºæ–¹æ¡ˆ
- [x] åˆ—å‡ºéœ€è¦ä¿®æ”¹çš„æ‰€æœ‰æª”æ¡ˆ
- [x] è©•ä¼°å¯¦ä½œè¤‡é›œåº¦å’Œé¢¨éšª

### å¯¦ä½œè¨ˆåŠƒ
- [x] æ›´æ–°æ‰€æœ‰ç›¸é—œ Spec æ–‡ä»¶
- [ ] æ›´æ–°ç›¸é—œ Task æ–‡ä»¶ï¼ˆå¾… Phase 1 é–‹ç™¼æ™‚é€æ­¥æ›´æ–°ï¼‰
- [x] é©—è­‰ Spec å®Œæ•´æ€§
- [x] Commit ä¸¦æ¨é€

### é©—è­‰ï¼ˆé–‹ç™¼å¾Œï¼‰
- [ ] æ‰€æœ‰ Task çš„éŒ¯èª¤è™•ç†æ¸¬è©¦é€šé
- [ ] çµæ§‹åŒ–æ—¥èªŒæ­£ç¢ºè¼¸å‡º
- [ ] Trace ID å¯ä»¥è¿½è¹¤å®Œæ•´æµç¨‹
- [ ] å‰ç«¯å¯ä»¥é¡¯ç¤ºè©³ç´°éŒ¯èª¤è³‡è¨Š

---

## è§£æ±ºæ–¹æ¡ˆå¯¦ä½œè¨˜éŒ„

### å·²å®Œæˆçš„ä¿®æ”¹

**æ–°å¢æª”æ¡ˆï¼ˆ3 å€‹ï¼‰ï¼š**
1. âœ… `tech-specs/backend/logging.md` - çµæ§‹åŒ–æ—¥èªŒè¦ç¯„
   - JSON æ ¼å¼æ—¥èªŒ
   - Trace ID è¿½è¹¤
   - StructuredLogger å¯¦ä½œ
2. âœ… `tech-specs/backend/error-codes.md` - å®Œæ•´éŒ¯èª¤ç¢¼é«”ç³»
   - æ¶µè“‹æ‰€æœ‰å¤–éƒ¨ APIï¼ˆGemini, Stability AI, D-ID, YouTubeï¼‰
   - æ¶µè“‹ç³»çµ±éŒ¯èª¤ï¼ˆFFmpeg, Redis, Databaseï¼‰
   - æ¯å€‹éŒ¯èª¤ç¢¼éƒ½æœ‰æ¢å¾©æŒ‡å—å’Œé‡è©¦ç­–ç•¥
3. âœ… `tech-specs/backend/monitoring.md` - éŒ¯èª¤ç›£æ§è¦ç¯„
   - P0/P1/P2 è­¦å ±è¦å‰‡
   - é…é¡ç›£æ§ç­–ç•¥
   - å¥åº·æª¢æŸ¥ç«¯é»

**ä¿®æ”¹æª”æ¡ˆï¼ˆ5 å€‹ï¼‰ï¼š**
1. âœ… `tech-specs/backend/business-logic.md`
   - ç§»é™¤è™›æ“¬ä¸»æ’­è‡ªå‹• fallback
   - æ”¹ç‚ºåš´æ ¼å¤±æ•—æ¨¡å¼
2. âœ… `tech-specs/backend/integrations.md`
   - ç§»é™¤ `generate_avatar_with_fallback`
   - æ”¹ç”¨ `generate_avatar_strict`ï¼Œæ˜ç¢ºæ‹‹å‡ºç•°å¸¸
3. âœ… `tech-specs/backend/overview.md`
   - æ›´æ–°æ—¥èªŒæ¶æ§‹ç‚ºçµæ§‹åŒ–æ—¥èªŒ
4. âœ… `tech-specs/backend/database.md`
   - Project è³‡æ–™è¡¨åŠ å…¥ `error_info` æ¬„ä½
   - å®šç¾© error_info JSON çµæ§‹
5. âœ… `tech-specs/frontend/api-integration.md`
   - çµ±ä¸€éŒ¯èª¤è™•ç†ç­–ç•¥
   - WebSocket éŒ¯èª¤è™•ç†èˆ‡å¾Œç«¯ä¸€è‡´
   - åŠ å…¥éŒ¯èª¤è§£æ±ºæ–¹æ¡ˆå°ç…§è¡¨

**ä¿®æ”¹çµ±è¨ˆï¼š**
- æ–°å¢è¡Œæ•¸ï¼šç´„ 1,200 è¡Œ
- ä¿®æ”¹è¡Œæ•¸ï¼šç´„ 150 è¡Œ
- æ¶µè“‹ç¯„åœï¼šå‰å¾Œç«¯å®Œæ•´éŒ¯èª¤è™•ç†é«”ç³»

---

## ç‹€æ…‹æ›´æ–°è¨˜éŒ„

| æ—¥æœŸ | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| 2025-10-20 | ğŸ”´ Open | å•é¡Œå»ºç«‹ï¼Œå¾…ä¿®æ”¹ Spec |
| 2025-10-20 | âœ… Resolved | Spec ä¿®æ”¹å®Œæˆï¼Œæ¡ç”¨æ–¹æ¡ˆ 1ï¼ˆå…¨é¢é‡æ§‹éŒ¯èª¤è™•ç†ï¼‰ |

---

## å‚™è¨»

é€™æ˜¯ä¸€å€‹åœ¨é–‹ç™¼å‰å°±ç™¼ç¾çš„è¨­è¨ˆå•é¡Œï¼Œä¿®æ”¹ spec å¾Œå¯ä»¥é¿å…å¤§é‡è¿”å·¥ã€‚é›–ç„¶ä¿®æ”¹ç¯„åœè¼ƒå¤§ï¼Œä½†å°é•·æœŸç¶­è­·æœ‰é‡å¤§å¥½è™•ã€‚

---

æœ€å¾Œæ›´æ–°ï¼š2025-10-20
